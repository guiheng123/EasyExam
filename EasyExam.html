<!DOCTYPE html>
<html lang="zh-CN">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>æç®€ç­”é¢˜ç³»ç»Ÿ Pro</title>
   <style>
       :root {
           --primary-color: #4e6ef2;
           --primary-hover: #405bd4;
           --bg-color: #f0f2f5;
           --card-bg: #ffffff;
           --text-main: #333333;
           --text-secondary: #666666;
           --correct-color: #e5f9e7;
           --correct-text: #2ba471;
           --wrong-color: #feebeb;
           --wrong-text: #d93025;
           --border-radius: 16px;
           --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
       }

       * { box-sizing: border-box; }

       body {
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
           background-color: var(--bg-color);
           color: var(--text-main);
           margin: 0;
           display: flex;
           justify-content: center;
           align-items: center;
           min-height: 100vh;
       }

       .container {
           width: 100%;
           height: 100vh;
           background-color: var(--card-bg);
           display: flex;
           flex-direction: column;
           position: relative;
           overflow: hidden;
           transition: all 0.3s ease;
       }

       @media (min-width: 768px) {
           .container {
               width: 90%;
               max-width: 1000px;
               height: 85vh;
               max-height: 800px;
               border-radius: 20px;
               box-shadow: var(--shadow-md);
           }
           body { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
       }

       .view-section {
           display: none;
           flex-direction: column;
           height: 100%;
           width: 100%;
           animation: fadeIn 0.3s ease;
       }

       .view-section.active { display: flex; }

       @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

       .header {
           padding: 15px 25px;
           display: flex;
           align-items: center;
           font-size: 18px;
           font-weight: 700;
           border-bottom: 1px solid #f0f0f0;
           background: #fff;
           flex-shrink: 0;
           z-index: 10;
       }

       .back-icon {
           margin-right: 15px;
           font-size: 20px;
           cursor: pointer;
           padding: 5px;
           border-radius: 50%;
           transition: background 0.2s;
           color: var(--text-secondary);
       }

       .back-icon:hover { background-color: #f5f5f5; }

       .home-layout {
           flex: 1;
           padding: 30px;
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
           overflow-y: auto;
       }

       #setup-panel {
           width: 100%;
           max-width: 600px;
           text-align: center;
       }

       /* Tabåˆ‡æ¢ */
       .tab-group {
           display: flex;
           background: #f1f5f9;
           padding: 4px;
           border-radius: 10px;
           margin-bottom: 20px;
       }

       .tab-btn {
           flex: 1;
           padding: 8px;
           font-size: 14px;
           font-weight: 600;
           color: #6b7280;
           cursor: pointer;
           border-radius: 8px;
           transition: 0.2s;
           border: none;
           background: transparent;
       }

       .tab-btn.active {
           background: #fff;
           color: var(--primary-color);
           box-shadow: 0 1px 2px rgba(0,0,0,0.05);
       }

       /* è¾“å…¥åŒºåŸŸ */
       .input-area { display: none; }
       .input-area.active { display: block; animation: fadeIn 0.2s; }

       /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
       .upload-zone {
           border: 2px dashed #e2e8f0;
           border-radius: 16px;
           padding: 40px 20px;
           background: #f8fafc;
           cursor: pointer;
           transition: all 0.2s;
       }

       .upload-zone:hover { border-color: var(--primary-color); background: #f0f7ff; }
       .upload-zone.drag-over { border-color: var(--primary-color); background: #e0edff; }

       .upload-icon { font-size: 32px; margin-bottom: 10px; }
       .upload-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 5px; }
       .upload-hint { font-size: 12px; color: #94a3b8; }

       /* æ–‡æœ¬ç²˜è´´æ¡† */
       .paste-box {
           width: 100%;
           height: 180px;
           padding: 12px;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           resize: none;
           font-family: monospace;
           font-size: 13px;
           background: #f8fafc;
       }

       .paste-box:focus { outline: none; border-color: var(--primary-color); background: #fff; }

       /* æ ¼å¼æç¤º */
       .format-hint {
           background: #fffbeb;
           border: 1px solid #fde68a;
           border-radius: 8px;
           padding: 12px;
           margin-top: 10px;
           text-align: left;
           font-size: 12px;
           color: #92400e;
           line-height: 1.6;
           margin-bottom: 10px;
       }

       .format-hint code { background: #fef3c7; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

       /* å­Tabï¼ˆç®€å•/JSONï¼‰ */
       .sub-tab { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
       .sub-tab-btn {
           padding: 6px 16px;
           font-size: 12px;
           border: 1px solid #e2e8f0;
           background: white;
           border-radius: 20px;
           cursor: pointer;
           color: #6b7280;
       }
       .sub-tab-btn.active { border-color: var(--primary-color); color: var(--primary-color); background: #f0f7ff; }

       /* é”™è¯¯æç¤º */
       .error-msg {
           background: #fee;
           border: 1px solid #fcc;
           color: #c33;
           padding: 10px;
           border-radius: 8px;
           margin-top: 10px;
           font-size: 13px;
           text-align: left;
           display: none;
       }

       .action-btn {
           width: 100%;
           padding: 12px;
           border-radius: 10px;
           border: none;
           font-size: 15px;
           font-weight: 600;
           cursor: pointer;
           transition: 0.2s;
           margin-top: 10px;
       }

       .btn-primary { background: var(--primary-color); color: white; }
       .btn-primary:hover { background: var(--primary-hover); }
       .btn-outline { background: transparent; border: 1px solid #e2e8f0; color: #6b7280; margin-top: 8px; }
       .btn-outline:hover { border-color: #6b7280; color: var(--text-main); background: #f8fafc; }

       /* å‡†å¤‡å°±ç»ªé¢æ¿ */
       #ready-panel {
           display: none;
           text-align: center;
           width: 100%;
           max-width: 400px;
           animation: slideUp 0.3s ease;
       }

       @keyframes slideUp { from { transform: translateY(15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

       .file-card {
           background: white;
           border: 1px solid #e2e8f0;
           border-radius: 16px;
           padding: 20px;
           margin-bottom: 20px;
           box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
       }

       .shuffle-options {
           background: #f8fafc;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           padding: 15px;
           margin-bottom: 15px;
           text-align: left;
       }

       .shuffle-options label { display: flex; align-items: center; margin: 8px 0; cursor: pointer; font-size: 14px; color: var(--text-secondary); }
       .shuffle-options input[type="checkbox"] { margin-right: 8px; width: 16px; height: 16px; accent-color: var(--primary-color); }

       /* ç­”é¢˜é¡µé¢ */
       .quiz-content {
           flex: 1;
           padding: 20px 30px;
           overflow-y: auto;
       }

       @media (min-width: 768px) {
           .quiz-layout-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; height: 100%; }
           .quiz-left-panel { border-right: 1px solid #eee; padding-right: 20px; display: flex; flex-direction: column; }
           .quiz-right-panel { padding-left: 10px; overflow-y: auto; }
           .question-text { font-size: 20px; }
       }

       @media (max-width: 767px) {
           .quiz-layout-wrapper { display: flex; flex-direction: column; }
           .question-text { font-size: 17px; }
       }

       .quiz-meta-info { color: #888; font-size: 13px; margin-bottom: 10px; }
       .quiz-meta-info #progressText { color: var(--primary-color); font-weight: bold; }
       .question-text { line-height: 1.6; margin-bottom: 20px; font-weight: 600; color: #222; }
       .options-list { display: flex; flex-direction: column; gap: 12px; }
       .option-item {
           background-color: #f7f8fa;
           padding: 16px 20px;
           border-radius: 12px;
           font-size: 16px;
           cursor: pointer;
           border: 2px solid transparent;
           transition: all 0.2s;
       }
       .option-item:hover:not(.disabled) { background-color: #ebedf0; }
       .option-item.correct { background-color: var(--correct-color); color: var(--correct-text); border-color: var(--correct-text); font-weight: 500; }
       .option-item.wrong { background-color: var(--wrong-color); color: var(--wrong-text); border-color: var(--wrong-text); }
       .disabled { pointer-events: none; }
       .analysis-box {
           margin-top: 20px;
           padding: 15px;
           background-color: #fff8e1;
           border-radius: 8px;
           font-size: 14px;
           color: #666;
           display: none;
           line-height: 1.6;
           border: 1px solid #ffeeba;
       }

       .quiz-footer {
           padding: 20px 30px;
           border-top: 1px solid #f0f0f0;
           background: #fff;
           display: flex;
           gap: 20px;
           flex-shrink: 0;
       }

       .nav-btn {
           flex: 1;
           padding: 14px;
           border-radius: 30px;
           font-size: 16px;
           font-weight: 700;
           border: none;
           cursor: pointer;
           transition: background-color 0.2s;
       }

       .btn-prev { background-color: #f5f5f5; color: #666; }
       .btn-prev:hover { background-color: #e9e9e9; }
       .btn-next { background-color: var(--primary-color); color: white; }
       .btn-next:hover { background-color: var(--primary-hover); }

       /* ç»“æœé¡µ */
       .result-layout {
           flex: 1;
           padding: 30px;
           overflow-y: auto;
           display: flex;
           flex-direction: column;
           align-items: center;
       }

       .score-circle-box { position: relative; width: 140px; height: 140px; margin-bottom: 20px; }
       .circle-bg { fill: none; stroke: #f1f5f9; stroke-width: 5; }
       .circle-bar { fill: none; stroke: var(--primary-color); stroke-width: 5; stroke-linecap: round; stroke-dasharray: 377; stroke-dashoffset: 377; transition: stroke-dashoffset 1s ease; }
       .score-val { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; font-weight: 800; color: var(--text-main); }

       .result-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
           gap: 8px;
           width: 100%;
           max-width: 400px;
           margin-top: 10px;
       }

       .grid-dot {
           aspect-ratio: 1;
           border-radius: 6px;
           font-size: 12px;
           font-weight: 600;
           display: flex;
           align-items: center;
           justify-content: center;
           background: #f1f5f9;
           color: #94a3b8;
           cursor: pointer;
           transition: 0.2s;
       }
       .grid-dot:hover { transform: scale(1.1); }
       .grid-dot.correct { background: var(--correct-color); color: var(--correct-text); }
       .grid-dot.wrong { background: var(--wrong-color); color: var(--wrong-text); }

       .hidden { display: none; }
   </style>
</head>
<body>
   <div class="container">
       <!-- é¦–é¡µ -->
       <div id="homeView" class="view-section active">
           <div class="home-layout">
               <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“</div>
               <h2 style="margin: 0 0 24px 0; color: var(--text-main); font-size: 20px;">æç®€ç­”é¢˜ Pro</h2>
               
               <div id="setup-panel">
                   <!-- ä¸»Tabï¼šæ–‡ä»¶ vs ç²˜è´´ -->
                   <div class="tab-group">
                       <button class="tab-btn active" onclick="setTab('file')">ğŸ“ æ–‡ä»¶å¯¼å…¥</button>
                       <button class="tab-btn" onclick="setTab('paste')">ğŸ“‹ æ–‡æœ¬ç²˜è´´</button>
                   </div>

                   <!-- æ–‡ä»¶å¯¼å…¥åŒºåŸŸ -->
                   <div id="area-file" class="input-area active">
                       <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                           <div class="upload-icon">ğŸ“‚</div>
                           <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½è‡³æ­¤</div>
                           <div class="upload-hint">æ”¯æŒ .txt .json æ ¼å¼</div>
                       </div>
                       <input type="file" id="fileInput" accept=".txt,.json" class="hidden" onchange="handleFileSelect(event)">
                       <div id="fileError" class="error-msg"></div>
                   </div>

                   <!-- æ–‡æœ¬ç²˜è´´åŒºåŸŸ -->
                   <div id="area-paste" class="input-area">
                       <!-- å­Tabï¼šç®€æ˜“ vs JSON -->
                       <div class="sub-tab">
                           <button class="sub-tab-btn active" onclick="setSubTab('simple')">ç®€æ˜“æ ¼å¼</button>
                           <button class="sub-tab-btn" onclick="setSubTab('json')">JSONæ ¼å¼</button>
                       </div>

                       <!-- ç®€æ˜“æ ¼å¼ -->
                       <div id="sub-simple" class="input-area active">
                           <textarea id="simpleInput" class="paste-box" placeholder="åœ¨æ­¤ç²˜è´´é¢˜ç›®..."></textarea>
                           <div class="format-hint">
                               <strong>ğŸ“ ç®€æ˜“æ ¼å¼ç¤ºä¾‹ï¼š</strong><br>
                               <code>Q:</code> é¢˜ç›®å†…å®¹<br>
                               <code>A:</code> é€‰é¡¹Aå†…å®¹<br>
                               <code>B:</code> é€‰é¡¹Bå†…å®¹<br>
                               <code>C:</code> é€‰é¡¹Cå†…å®¹<br>
                               <code>D:</code> é€‰é¡¹Då†…å®¹<br>
                               <code>ç­”æ¡ˆ:</code> B<br>
                               <code>è§£æ:</code> è¿™æ˜¯è§£æ(å¯é€‰)<br>
                               <code>---</code> åˆ†éš”ç¬¦<br><br>
                               <small>ğŸ’¡ ç®€æ˜“æ ¼å¼æå¤§èŠ‚çœAIç”Ÿæˆtokenï¼Œå»ºè®®é¦–é€‰</small>
                           </div>
                           <button class="action-btn btn-primary" onclick="parseText('simple')">è§£æé¢˜ç›®</button>
                       </div>

                       <!-- JSONæ ¼å¼ -->
                       <div id="sub-json" class="input-area">
                           <textarea id="jsonInput" class="paste-box" placeholder='ç²˜è´´ JSON æ ¼å¼é¢˜åº“...'></textarea>
                           <div class="format-hint">
                               <strong>ğŸ“‹ JSONæ ¼å¼ç¤ºä¾‹ï¼š</strong><br>
                               <code>[{"q":"é¢˜ç›®","o":["A","B","C","D"],"a":1,"e":"è§£æ"}]</code><br>
                               <small>q=é¢˜ç›®, o=é€‰é¡¹æ•°ç»„, a=ç­”æ¡ˆç´¢å¼•(0-3æˆ–å­—æ¯), e=è§£æ(å¯é€‰)</small>
                           </div>
                           <button class="action-btn btn-primary" onclick="parseText('json')">è§£æé¢˜ç›®</button>
                       </div>

                       <div id="pasteError" class="error-msg"></div>
                   </div>
               </div>

               <!-- å‡†å¤‡å°±ç»ªé¢æ¿ -->
               <div id="ready-panel">
                   <div class="file-card">
                       <div style="color: var(--correct-text); font-size: 24px; margin-bottom: 8px;">âœ“</div>
                       <div style="font-weight: 600; margin-bottom: 4px;">é¢˜åº“å·²åŠ è½½</div>
                       <div style="color: var(--text-secondary); font-size: 13px;">å…± <span id="qCount">0</span> é“é¢˜ç›®</div>
                   </div>
                   <div class="shuffle-options">
                       <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-main);">ğŸ² ç­”é¢˜è®¾ç½®</div>
                       <label><input type="checkbox" id="shuffleQuestions" checked> æ‰“ä¹±é¢˜ç›®é¡ºåº</label>
                       <label><input type="checkbox" id="shuffleOptions" checked> æ‰“ä¹±é€‰é¡¹é¡ºåº</label>
                   </div>
                   <button class="action-btn btn-primary" onclick="startQuiz()">å¼€å§‹ç­”é¢˜</button>
                   <button class="action-btn btn-outline" onclick="resetImport()">é‡æ–°å¯¼å…¥</button>
               </div>
           </div>
       </div>

       <!-- ç­”é¢˜é¡µ -->
       <div id="quizView" class="view-section">
           <div class="header">
               <span class="back-icon" onclick="confirmExit()">â†</span>
               <span>ç­”é¢˜ä¸­</span>
           </div>
           <div class="quiz-content">
               <div class="quiz-layout-wrapper">
                   <div class="quiz-left-panel">
                       <div class="quiz-meta-info">é¢˜ç›® <span id="progressText">1/10</span></div>
                       <div class="question-text" id="questionText">é¢˜ç›®åŠ è½½ä¸­...</div>
                   </div>
                   <div class="quiz-right-panel">
                       <div class="options-list" id="optionsContainer"></div>
                       <div class="analysis-box" id="analysisBox">
                           <div style="font-weight:bold; margin-bottom:5px; color:var(--text-main)">ğŸ’¡ è§£æï¼š</div>
                           <div id="analysisContent"></div>
                       </div>
                   </div>
               </div>
           </div>
           <div class="quiz-footer">
               <button class="nav-btn btn-prev" id="prevBtn" onclick="prevQ()">ä¸Šä¸€é¢˜</button>
               <button class="nav-btn btn-next" id="nextBtn" onclick="nextQ()">ä¸‹ä¸€é¢˜</button>
           </div>
       </div>

       <!-- ç»“æœé¡µ -->
       <div id="resultView" class="view-section">
           <div class="header">
               <div style="width:100%; text-align:center;">ç»“æœæ¦‚è§ˆ</div>
           </div>
           <div class="result-layout">
               <div class="score-circle-box">
                   <svg width="140" height="140" viewBox="0 0 140 140">
                       <circle class="circle-bg" cx="70" cy="70" r="60"></circle>
                       <circle class="circle-bar" id="scoreCircle" cx="70" cy="70" r="60"></circle>
                   </svg>
                   <div class="score-val"><span id="scoreVal">0</span><span style="font-size:14px; color:#999">%</span></div>
               </div>
               <div style="font-size:13px; color:var(--text-secondary); margin-bottom:15px;">é¢˜ç›®å›é¡¾ï¼ˆç‚¹å‡»å¯æŸ¥çœ‹ï¼‰</div>
               <div class="result-grid" id="resultGrid"></div>
               <button class="action-btn btn-outline" style="margin-top: 40px;" onclick="resetImport()">â† è¿”å›é¦–é¡µ</button>
           </div>
       </div>
   </div>

   <script>
       let questions = [];
       let originalQuestions = [];
       let userAnswers = [];
       let currentIndex = 0;
       let isReviewMode = false;

       // ========== ç•Œé¢åˆ‡æ¢ ==========
       function setTab(mode) {
           const areas = document.querySelectorAll('.input-area');
           const btns = document.querySelectorAll('.tab-group .tab-btn');
           
           btns.forEach(b => b.classList.remove('active'));
           
           if (mode === 'file') {
               btns[0].classList.add('active');
               document.getElementById('area-file').classList.add('active');
               document.getElementById('area-paste').classList.remove('active');
               hideErrors();
           } else {
               btns[1].classList.add('active');
               document.getElementById('area-file').classList.remove('active');
               document.getElementById('area-paste').classList.add('active');
           }
       }

       function setSubTab(mode) {
           document.querySelectorAll('#area-paste .sub-tab-btn').forEach(b => b.classList.remove('active'));
           
           if (mode === 'simple') {
               document.querySelectorAll('#area-paste .sub-tab-btn')[0].classList.add('active');
               document.getElementById('sub-simple').classList.add('active');
               document.getElementById('sub-json').classList.remove('active');
           } else {
               document.querySelectorAll('#area-paste .sub-tab-btn')[1].classList.add('active');
               document.getElementById('sub-simple').classList.remove('active');
               document.getElementById('sub-json').classList.add('active');
           }
           hideErrors();
       }

       function hideErrors() {
           document.getElementById('fileError').style.display = 'none';
           document.getElementById('pasteError').style.display = 'none';
       }

       // ========== æ–‡ä»¶å¯¼å…¥ ==========
       const uploadZone = document.getElementById('uploadZone');
       
       uploadZone.addEventListener('dragover', (e) => {
           e.preventDefault();
           uploadZone.classList.add('drag-over');
       });
       
       uploadZone.addEventListener('dragleave', () => {
           uploadZone.classList.remove('drag-over');
       });
       
       uploadZone.addEventListener('drop', (e) => {
           e.preventDefault();
           uploadZone.classList.remove('drag-over');
           const files = e.dataTransfer.files;
           if (files.length > 0) processFile(files[0]);
       });

       function handleFileSelect(e) {
           if (e.target.files.length > 0) processFile(e.target.files[0]);
       }

       function processFile(file) {
           const reader = new FileReader();
           reader.onload = (e) => {
               const content = e.target.result;
               // å°è¯•JSONè§£æï¼Œå¤±è´¥åˆ™æŒ‰ç®€æ˜“æ ¼å¼è§£æ
               try {
                   const json = JSON.parse(content);
                   parseImportData(json, false);
               } catch {
                   parseSimpleContent(content, false);
               }
           };
           reader.onerror = () => showError('æ–‡ä»¶è¯»å–å¤±è´¥', 'file');
           reader.readAsText(file);
       }

       // ========== æ–‡æœ¬ç²˜è´´ ==========
       function parseText(type) {
           if (type === 'simple') {
               const text = document.getElementById('simpleInput').value.trim();
               if (!text) { showError('è¯·å…ˆç²˜è´´é¢˜ç›®å†…å®¹', 'paste'); return; }
               parseSimpleContent(text, false);
           } else {
               const text = document.getElementById('jsonInput').value.trim();
               if (!text) { showError('è¯·å…ˆç²˜è´´JSONå†…å®¹', 'paste'); return; }
               try {
                   const json = JSON.parse(text);
                   // å¦‚æœæ˜¯æ•°ç»„ï¼Œç›´æ¥è§£æï¼›å¦‚æœæ˜¯å¯¹è±¡ä¸”æœ‰qå­—æ®µï¼ŒåŒ…è£…æˆæ•°ç»„
                   if (Array.isArray(json)) {
                       parseImportData(json, false);
                   } else if (json.q || json.question) {
                       parseImportData([json], false);
                   } else {
                       showError('JSONæ ¼å¼é”™è¯¯ï¼šåº”ä¸ºæ•°ç»„æˆ–åŒ…å«q/questionçš„å¯¹è±¡', 'paste');
                   }
               } catch(e) {
                   showError('JSONè§£æå¤±è´¥ï¼š' + e.message, 'paste');
               }
           }
       }

       // ========== ç®€æ˜“æ ¼å¼è§£æ ==========
       function parseSimpleContent(text, isCheck) {
           // æ”¯æŒ --- æˆ– === æˆ– ä¸‰ä¸ªä»¥ä¸Š - = ä½œä¸ºåˆ†éš”ç¬¦
           const blocks = text.split(/\n\s*(?:---+|===+)\s*\n/).filter(b => b.trim());
           if (blocks.length === 0) {
               if (!isCheck) showError('æœªæ‰¾åˆ°æœ‰æ•ˆé¢˜ç›®ï¼Œè¯·ä½¿ç”¨ --- æˆ– === åˆ†éš”é¢˜ç›®', 'paste');
               return false;
           }

           const parsed = [];
           const errors = [];

           for (let i = 0; i < blocks.length; i++) {
               const lines = blocks[i].split('\n').map(l => l.trim()).filter(l => l);
               if (lines.length === 0) continue;

               const q = { question: '', options: [], correctIndex: -1, explanation: '' };

               for (const line of lines) {
                   // åŒ¹é…é¢˜ç›®è¡Œï¼ˆQ: æˆ– çº¯æ–‡æœ¬å¼€å¤´ï¼‰
                   if (line.match(/^Q[:ï¼š]\s*/i)) {
                       q.question = line.replace(/^Q[:ï¼š]\s*/i, '');
                   }
                   // åŒ¹é…é€‰é¡¹ A: B: C: D: æ”¯æŒä¸­è‹±æ–‡å†’å·
                   else if (line.match(/^[A-Da-d][:ï¼šã€.]\s*/)) {
                       const content = line.replace(/^[A-Da-d][:ï¼šã€.]\s*/, '');
                       q.options.push(content);
                   }
                   // åŒ¹é…ç­”æ¡ˆï¼ˆç­”æ¡ˆ: æˆ– Answer:ï¼‰
                   else if (line.match(/^(ç­”æ¡ˆ|Answer)[:ï¼š]\s*/i)) {
                       const ans = line.replace(/^(ç­”æ¡ˆ|Answer)[:ï¼š]\s*/i, '').trim();
                       if (/^[A-Da-d]$/.test(ans)) {
                           q.correctIndex = ans.toUpperCase().charCodeAt(0) - 65;
                       } else if (/^\d+$/.test(ans)) {
                           q.correctIndex = parseInt(ans);
                       }
                   }
                   // åŒ¹é…è§£æ
                   else if (line.match(/^(è§£æ|Explain|Note|æ³¨é‡Š)[:ï¼š]\s*/i)) {
                       q.explanation = line.replace(/^(è§£æ|Explain|Note|æ³¨é‡Š)[:ï¼š]\s*/i, '');
                   }
                   // å¦‚æœæ²¡æœ‰Qæ ‡è®°ï¼Œç¬¬ä¸€è¡Œéé€‰é¡¹å†…å®¹ä½œä¸ºé¢˜ç›®
                   else if (!q.question && !line.match(/^[A-Da-d][:ï¼šã€.]/)) {
                       q.question = line;
                   }
               }

               // éªŒè¯
               if (!q.question) errors.push(`ç¬¬${i+1}é¢˜ï¼šç¼ºå°‘é¢˜ç›®`);
               else if (q.options.length < 2) errors.push(`ç¬¬${i+1}é¢˜ï¼šé€‰é¡¹ä¸è¶³ï¼ˆè‡³å°‘éœ€è¦2ä¸ªï¼‰`);
               else if (q.correctIndex < 0 || q.correctIndex >= q.options.length) errors.push(`ç¬¬${i+1}é¢˜ï¼šç­”æ¡ˆæ— æ•ˆæˆ–ç¼ºå¤±`);
               else parsed.push(q);
           }

           if (errors.length > 0) {
               if (!isCheck) showError(errors.join('ï¼›'), 'paste');
               return false;
           }

           if (parsed.length > 0 && !isCheck) {
               originalQuestions = parsed;
               showReady(parsed.length);
           }
           return parsed.length > 0;
       }

       // ========== JSONæ ¼å¼è§£æ ==========
       function parseImportData(data, isCheck) {
           if (!Array.isArray(data)) {
               if (!isCheck) showError('æ•°æ®å¿…é¡»ä¸ºæ•°ç»„æ ¼å¼', 'paste');
               return false;
           }

           const parsed = [];
           const errors = [];

           for (let i = 0; i < data.length; i++) {
               const item = data[i];
               const q = { question: '', options: [], correctIndex: 0, explanation: '' };

               // å…¼å®¹å¤šç§å­—æ®µå
               if (item.q !== undefined) {
                   q.question = item.q;
                   q.options = Array.isArray(item.o) ? item.o : [];
                   // ç­”æ¡ˆå¯èƒ½æ˜¯æ•°å­—æˆ–å­—æ¯
                   if (typeof item.a === 'string' && /^[A-Da-d]$/.test(item.a)) {
                       q.correctIndex = item.a.toUpperCase().charCodeAt(0) - 65;
                   } else {
                       q.correctIndex = parseInt(item.a) || 0;
                   }
                   q.explanation = item.e || '';
               } else if (item.question !== undefined) {
                   q.question = item.question;
                   q.options = Array.isArray(item.options) ? item.options : [];
                   if (typeof item.correctIndex === 'string' && /^[A-Da-d]$/.test(item.correctIndex)) {
                       q.correctIndex = item.correctIndex.toUpperCase().charCodeAt(0) - 65;
                   } else {
                       q.correctIndex = parseInt(item.correctIndex) || parseInt(item.answer) || 0;
                   }
                   q.explanation = item.explanation || item.explain || '';
               } else {
                   errors.push(`ç¬¬${i+1}é¡¹ï¼šç¼ºå°‘å¿…è¦çš„é¢˜ç›®å­—æ®µ`);
                   continue;
               }

               if (!q.question) errors.push(`ç¬¬${i+1}é¡¹ï¼šé¢˜ç›®å†…å®¹ä¸ºç©º`);
               else if (q.options.length < 2) errors.push(`ç¬¬${i+1}é¡¹ï¼šé€‰é¡¹ä¸è¶³2ä¸ª`);
               else if (q.correctIndex < 0 || q.correctIndex >= q.options.length) errors.push(`ç¬¬${i+1}é¡¹ï¼šç­”æ¡ˆç´¢å¼•è¶…å‡ºèŒƒå›´`);
               else parsed.push(q);
           }

           if (errors.length > 0) {
               if (!isCheck) showError(errors.join('ï¼›'), 'paste');
               return false;
           }

           if (parsed.length > 0 && !isCheck) {
               originalQuestions = parsed;
               showReady(parsed.length);
           }
           return parsed.length > 0;
       }

       // ========== è¾…åŠ©åŠŸèƒ½ ==========
       function showError(msg, type) {
           const el = type === 'file' ? document.getElementById('fileError') : document.getElementById('pasteError');
           el.textContent = msg;
           el.style.display = 'block';
           setTimeout(() => { el.style.display = 'none'; }, 5000);
       }

       function showReady(count) {
           document.getElementById('qCount').innerText = count;
           document.getElementById('setup-panel').style.display = 'none';
           document.getElementById('ready-panel').style.display = 'block';
       }

       function resetImport() {
           originalQuestions = [];
           questions = [];
           userAnswers = [];
           currentIndex = 0;
           isReviewMode = false;
           
           // æ¸…ç©ºè¾“å…¥
           document.getElementById('fileInput').value = '';
           document.getElementById('simpleInput').value = '';
           document.getElementById('jsonInput').value = '';
           
           // é‡ç½®ç•Œé¢
           document.getElementById('setup-panel').style.display = 'block';
           document.getElementById('ready-panel').style.display = 'none';
           hideErrors();
           switchView('homeView');
       }

       function switchView(id) {
           document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
           document.getElementById(id).classList.add('active');
       }

       // ========== ç­”é¢˜é€»è¾‘ ==========
       function shuffleArray(arr) {
           const newArr = [...arr];
           for (let i = newArr.length - 1; i > 0; i--) {
               const j = Math.floor(Math.random() * (i + 1));
               [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
           }
           return newArr;
       }

       function startQuiz() {
           // æ·±æ‹·è´å¹¶åº”ç”¨æ‰“ä¹±
           questions = JSON.parse(JSON.stringify(originalQuestions));

           if (document.getElementById('shuffleQuestions').checked) {
               questions = shuffleArray(questions);
           }

           if (document.getElementById('shuffleOptions').checked) {
               questions.forEach(q => {
                   const correctContent = q.options[q.correctIndex];
                   q.options = shuffleArray(q.options);
                   q.correctIndex = q.options.indexOf(correctContent);
               });
           }

           userAnswers = new Array(questions.length).fill(null);
           currentIndex = 0;
           isReviewMode = false;
           renderQuestion();
           switchView('quizView');
       }

       function renderQuestion() {
           const q = questions[currentIndex];
           const record = userAnswers[currentIndex];

           document.getElementById('progressText').innerText = `${currentIndex + 1} / ${questions.length}`;
           document.getElementById('questionText').innerText = q.question;

           const container = document.getElementById('optionsContainer');
           container.innerHTML = '';
           document.getElementById('analysisBox').style.display = 'none';

           q.options.forEach((opt, idx) => {
               const btn = document.createElement('div');
               btn.className = 'option-item';
               btn.innerText = String.fromCharCode(65 + idx) + '. ' + opt;

               if (record) {
                   btn.classList.add('disabled');
                   if (idx === q.correctIndex) btn.classList.add('correct');
                   if (idx === record.selectedIndex && idx !== q.correctIndex) btn.classList.add('wrong');
               } else {
                   btn.onclick = () => handleAnswer(idx, btn);
               }
               container.appendChild(btn);
           });

           if (record && q.explanation) showAnalysis(q.explanation);
           updateNavButtons();
       }

       function handleAnswer(idx, el) {
           const q = questions[currentIndex];
           const isCorrect = idx === q.correctIndex;
           userAnswers[currentIndex] = { selectedIndex: idx, isCorrect };

           const allOpts = document.querySelectorAll('.option-item');
           allOpts.forEach(o => o.classList.add('disabled'));

           if (isCorrect) {
               el.classList.add('correct');
           } else {
               el.classList.add('wrong');
               allOpts[q.correctIndex].classList.add('correct');
           }

           if (q.explanation) showAnalysis(q.explanation);
           updateNavButtons();
       }

       function showAnalysis(txt) {
           document.getElementById('analysisContent').innerText = txt;
           document.getElementById('analysisBox').style.display = 'block';
       }

       function updateNavButtons() {
           const prev = document.getElementById('prevBtn');
           const next = document.getElementById('nextBtn');
           const isLast = currentIndex === questions.length - 1;

           prev.style.visibility = currentIndex === 0 ? 'hidden' : 'visible';

           if (isReviewMode) {
               next.innerText = 'è¿”å›ç»“æœ';
               next.onclick = showResult;
           } else {
               next.innerText = isLast ? 'æäº¤' : 'ä¸‹ä¸€é¢˜';
               next.onclick = isLast ? showResult : nextQ;
           }
       }

       function prevQ() {
           if (currentIndex > 0) {
               currentIndex--;
               renderQuestion();
           }
       }

       function nextQ() {
           if (currentIndex < questions.length - 1) {
               currentIndex++;
               renderQuestion();
           }
       }

       function confirmExit() {
           if (isReviewMode) {
               showResult();
           } else if (confirm('ç¡®å®šé€€å‡ºï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
               resetImport();
           }
       }

       function showResult() {
           switchView('resultView');
           isReviewMode = false;

           let correct = 0;
           userAnswers.forEach(u => { if (u && u.isCorrect) correct++; });
           const pct = questions.length ? Math.round((correct / questions.length) * 100) : 0;

           const circle = document.getElementById('scoreCircle');
           const circumference = 2 * Math.PI * 60;
           const offset = circumference - (pct / 100) * circumference;
           circle.style.strokeDasharray = circumference;
           circle.style.strokeDashoffset = circumference;
           setTimeout(() => { circle.style.strokeDashoffset = offset; }, 50);

           document.getElementById('scoreVal').innerText = pct;

           const grid = document.getElementById('resultGrid');
           grid.innerHTML = '';
           questions.forEach((q, i) => {
               const dot = document.createElement('div');
               dot.className = 'grid-dot';
               dot.innerText = i + 1;
               const ans = userAnswers[i];
               if (ans) {
                   dot.classList.add(ans.isCorrect ? 'correct' : 'wrong');
               }
               dot.onclick = () => {
                   currentIndex = i;
                   isReviewMode = true;
                   renderQuestion();
                   switchView('quizView');
               };
               grid.appendChild(dot);
           });
       }
   </script>
</body>
</html>
