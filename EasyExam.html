<!DOCTYPE html>
<html lang="zh-CN">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>æç®€ç­”é¢˜ç³»ç»Ÿ Pro</title>
   <style>
       :root {
           --primary-color: #4e6ef2;
           --primary-hover: #405bd4;
           --bg-color: #f0f2f5;
           --card-bg: #ffffff;
           --text-main: #333333;
           --text-secondary: #666666;
           --correct-color: #e5f9e7;
           --correct-text: #2ba471;
           --wrong-color: #feebeb;
           --wrong-text: #d93025;
           --border-radius: 16px;
           --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
       }

       * { box-sizing: border-box; }

       body {
           font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
           background-color: var(--bg-color);
           color: var(--text-main);
           margin: 0;
           display: flex;
           justify-content: center;
           align-items: center;
           min-height: 100vh;
       }

       .container {
           width: 100%;
           height: 100vh;
           background-color: var(--card-bg);
           display: flex;
           flex-direction: column;
           position: relative;
           overflow: hidden;
           transition: all 0.3s ease;
       }

       @media (min-width: 768px) {
           .container {
               width: 90%;
               max-width: 1000px;
               height: 85vh;
               max-height: 800px;
               border-radius: 20px;
               box-shadow: var(--shadow-md);
           }
           body { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
       }

       .view-section {
           display: none;
           flex-direction: column;
           height: 100%;
           width: 100%;
           animation: fadeIn 0.3s ease;
       }

       .view-section.active { display: flex; }

       @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

       .header {
           padding: 15px 25px;
           display: flex;
           align-items: center;
           font-size: 18px;
           font-weight: 700;
           border-bottom: 1px solid #f0f0f0;
           background: #fff;
           flex-shrink: 0;
           z-index: 10;
       }

       .back-icon {
           margin-right: 15px;
           font-size: 20px;
           cursor: pointer;
           padding: 5px;
           border-radius: 50%;
           transition: background 0.2s;
           color: var(--text-secondary);
       }

       .back-icon:hover { background-color: #f5f5f5; }

       .home-layout {
           flex: 1;
           padding: 30px;
           display: flex;
           flex-direction: column;
           align-items: center;
           justify-content: center;
           overflow-y: auto;
       }

       #setup-panel {
           width: 100%;
           max-width: 600px;
           text-align: center;
       }

       /* Tabåˆ‡æ¢ */
       .tab-group {
           display: flex;
           background: #f1f5f9;
           padding: 4px;
           border-radius: 10px;
           margin-bottom: 20px;
       }

       .tab-btn {
           flex: 1;
           padding: 8px;
           font-size: 14px;
           font-weight: 600;
           color: #6b7280;
           cursor: pointer;
           border-radius: 8px;
           transition: 0.2s;
           border: none;
           background: transparent;
       }

       .tab-btn.active {
           background: #fff;
           color: var(--primary-color);
           box-shadow: 0 1px 2px rgba(0,0,0,0.05);
       }

       /* è¾“å…¥åŒºåŸŸ */
       .input-area { display: none; }
       .input-area.active { display: block; animation: fadeIn 0.2s; }

       /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
       .upload-zone {
           border: 2px dashed #e2e8f0;
           border-radius: 16px;
           padding: 40px 20px;
           background: #f8fafc;
           cursor: pointer;
           transition: all 0.2s;
       }

       .upload-zone:hover { border-color: var(--primary-color); background: #f0f7ff; }
       .upload-zone.drag-over { border-color: var(--primary-color); background: #e0edff; }

       .upload-icon { font-size: 32px; margin-bottom: 10px; }
       .upload-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 5px; }
       .upload-hint { font-size: 12px; color: #94a3b8; }

       /* æ–‡æœ¬ç²˜è´´æ¡† */
       .paste-box {
           width: 100%;
           height: 200px;
           padding: 12px;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           resize: vertical;
           font-family: monospace;
           font-size: 13px;
           background: #f8fafc;
           margin-bottom: 10px;
       }

       .paste-box:focus { outline: none; border-color: var(--primary-color); background: #fff; }

       /* å­Tabï¼ˆé¢„è®¾/è‡ªå®šä¹‰ï¼‰ */
       .sub-tab { 
           display: flex; 
           gap: 8px; 
           margin-bottom: 15px; 
           justify-content: center;
           flex-wrap: wrap;
       }
       .sub-tab-btn {
           padding: 8px 20px;
           font-size: 13px;
           font-weight: 600;
           border: 1px solid #e2e8f0;
           background: white;
           border-radius: 20px;
           cursor: pointer;
           color: #6b7280;
           transition: all 0.2s;
       }
       .sub-tab-btn.active { 
           border-color: var(--primary-color); 
           color: var(--primary-color); 
           background: #f0f7ff;
           box-shadow: 0 2px 4px rgba(78, 110, 242, 0.1);
       }

       /* é¢„è®¾æ ¼å¼å¡ç‰‡ */
       .preset-list {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
           gap: 12px;
           margin-bottom: 15px;
       }

       .preset-card {
           border: 2px solid #e2e8f0;
           border-radius: 12px;
           padding: 14px;
           cursor: pointer;
           transition: all 0.2s;
           background: white;
           text-align: left;
           position: relative;
       }

       .preset-card:hover {
           border-color: var(--primary-color);
           box-shadow: 0 4px 12px rgba(78, 110, 242, 0.15);
           transform: translateY(-2px);
       }

       .preset-card.selected {
           border-color: var(--primary-color);
           background: #f0f7ff;
       }

       .preset-card-title {
           font-weight: 600;
           font-size: 15px;
           margin-bottom: 6px;
           color: var(--text-main);
       }

       .preset-card-desc {
           font-size: 12px;
           color: var(--text-secondary);
           line-height: 1.5;
           margin-bottom: 8px;
       }

       .preset-card-example-btn {
           display: inline-block;
           padding: 4px 10px;
           background: #f1f5f9;
           border-radius: 6px;
           font-size: 11px;
           color: var(--primary-color);
           cursor: pointer;
           margin-top: 4px;
           transition: 0.2s;
       }

       .preset-card-example-btn:hover {
           background: #e0edff;
       }

       /* ä¾‹é¢˜æ¨¡æ€æ¡† */
       .modal-overlay {
           display: none;
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: rgba(0, 0, 0, 0.5);
           z-index: 1000;
           align-items: center;
           justify-content: center;
           animation: fadeIn 0.2s;
       }

       .modal-overlay.active {
           display: flex;
       }

       .modal-content {
           background: white;
           border-radius: 16px;
           max-width: 600px;
           width: 90%;
           max-height: 80vh;
           overflow-y: auto;
           padding: 0;
           animation: slideUp 0.3s;
       }

       @keyframes slideUp {
           from { transform: translateY(20px); opacity: 0; }
           to { transform: translateY(0); opacity: 1; }
       }

       .modal-header {
           padding: 20px;
           border-bottom: 1px solid #f0f0f0;
           display: flex;
           justify-content: space-between;
           align-items: center;
           position: sticky;
           top: 0;
           background: white;
           z-index: 1;
       }

       .modal-title {
           font-size: 18px;
           font-weight: 600;
           color: var(--text-main);
       }

       .modal-close {
           cursor: pointer;
           font-size: 24px;
           color: var(--text-secondary);
           width: 32px;
           height: 32px;
           display: flex;
           align-items: center;
           justify-content: center;
           border-radius: 50%;
           transition: 0.2s;
       }

       .modal-close:hover {
           background: #f5f5f5;
       }

       .modal-body {
           padding: 20px;
       }

       .example-section {
           background: #f8fafc;
           border-radius: 8px;
           padding: 15px;
           margin-bottom: 15px;
       }

       .example-title {
           font-size: 13px;
           font-weight: 600;
           color: var(--text-main);
           margin-bottom: 8px;
       }

       .example-code {
           background: #1e293b;
           color: #e2e8f0;
           padding: 12px;
           border-radius: 6px;
           font-family: 'Courier New', monospace;
           font-size: 12px;
           line-height: 1.6;
           white-space: pre-wrap;
           overflow-x: auto;
       }

       .copy-example-btn {
           margin-top: 10px;
           padding: 8px 16px;
           background: var(--primary-color);
           color: white;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           font-size: 12px;
           transition: 0.2s;
       }

       .copy-example-btn:hover {
           background: var(--primary-hover);
       }

       /* è‡ªå®šä¹‰æ ¼å¼ç¼–è¾‘å™¨ - é‡æ–°è®¾è®¡ */
       .custom-format-container {
           text-align: left;
       }

       .custom-mode-switch {
           display: flex;
           gap: 10px;
           margin-bottom: 20px;
           background: #f8fafc;
           padding: 8px;
           border-radius: 10px;
       }

       .mode-btn {
           flex: 1;
           padding: 10px;
           border: 2px solid transparent;
           background: white;
           border-radius: 8px;
           cursor: pointer;
           font-size: 13px;
           font-weight: 600;
           color: var(--text-secondary);
           transition: 0.2s;
           text-align: center;
       }

       .mode-btn.active {
           border-color: var(--primary-color);
           color: var(--primary-color);
           background: #f0f7ff;
       }

       .mode-desc {
           font-size: 11px;
           display: block;
           margin-top: 4px;
           font-weight: normal;
       }

       .custom-simple-mode,
       .custom-advanced-mode {
           display: none;
       }

       .custom-simple-mode.active,
       .custom-advanced-mode.active {
           display: block;
       }

       /* ç®€å•æ¨¡å¼ */
       .simple-format-builder {
           background: #f8fafc;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           padding: 20px;
       }

       .format-field {
           margin-bottom: 16px;
       }

       .format-field label {
           display: flex;
           align-items: center;
           font-size: 13px;
           font-weight: 600;
           margin-bottom: 6px;
           color: var(--text-main);
       }

       .help-icon {
           margin-left: 6px;
           display: inline-flex;
           align-items: center;
           justify-content: center;
           width: 16px;
           height: 16px;
           background: #e2e8f0;
           color: var(--text-secondary);
           border-radius: 50%;
           font-size: 11px;
           cursor: help;
       }

       .format-field input {
           width: 100%;
           padding: 10px 12px;
           border: 1px solid #e2e8f0;
           border-radius: 8px;
           font-size: 13px;
           transition: 0.2s;
       }

       .format-field input:focus {
           outline: none;
           border-color: var(--primary-color);
           box-shadow: 0 0 0 3px rgba(78, 110, 242, 0.1);
       }

       .format-field-help {
           font-size: 11px;
           color: #94a3b8;
           margin-top: 4px;
           line-height: 1.4;
       }

       .quick-templates {
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
           gap: 8px;
           margin-top: 8px;
       }

       .template-chip {
           padding: 6px 10px;
           background: white;
           border: 1px solid #e2e8f0;
           border-radius: 6px;
           font-size: 11px;
           cursor: pointer;
           text-align: center;
           transition: 0.2s;
       }

       .template-chip:hover {
           border-color: var(--primary-color);
           color: var(--primary-color);
       }

       /* é«˜çº§æ¨¡å¼ */
       .advanced-format-editor {
           background: #f8fafc;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           padding: 20px;
       }

       .regex-field {
           margin-bottom: 20px;
       }

       .regex-input-group {
           position: relative;
       }

       .regex-input {
           font-family: 'Courier New', monospace;
           background: #1e293b;
           color: #e2e8f0;
           border: 2px solid #334155;
       }

       .regex-input:focus {
           border-color: var(--primary-color);
       }

       .regex-test-btn {
           margin-top: 8px;
           padding: 6px 12px;
           background: #334155;
           color: white;
           border: none;
           border-radius: 6px;
           cursor: pointer;
           font-size: 12px;
       }

       .regex-test-btn:hover {
           background: #475569;
       }

       /* ä¿å­˜çš„æ ¼å¼åˆ—è¡¨ */
       .saved-formats {
           margin-top: 20px;
       }

       .saved-formats-title {
           font-size: 14px;
           font-weight: 600;
           margin-bottom: 12px;
           color: var(--text-main);
       }

       .saved-format-item {
           display: flex;
           justify-content: space-between;
           align-items: center;
           padding: 12px;
           background: white;
           border: 1px solid #e2e8f0;
           border-radius: 8px;
           margin-bottom: 8px;
           transition: 0.2s;
       }

       .saved-format-item:hover {
           border-color: #cbd5e1;
           box-shadow: 0 2px 4px rgba(0,0,0,0.05);
       }

       .saved-format-info {
           flex: 1;
       }

       .saved-format-name {
           font-size: 13px;
           font-weight: 600;
           color: var(--text-main);
           margin-bottom: 2px;
       }

       .saved-format-meta {
           font-size: 11px;
           color: var(--text-secondary);
       }

       .saved-format-actions {
           display: flex;
           gap: 6px;
       }

       .icon-btn {
           padding: 6px 10px;
           border: none;
           background: #f1f5f9;
           cursor: pointer;
           font-size: 12px;
           color: var(--text-secondary);
           border-radius: 6px;
           transition: 0.2s;
       }

       .icon-btn:hover {
           background: #e2e8f0;
           color: var(--text-main);
       }

       .icon-btn.primary {
           background: var(--primary-color);
           color: white;
       }

       .icon-btn.primary:hover {
           background: var(--primary-hover);
       }

       /* é”™è¯¯æç¤º */
       .error-msg {
           background: #fee;
           border: 1px solid #fcc;
           color: #c33;
           padding: 10px;
           border-radius: 8px;
           margin-top: 10px;
           font-size: 13px;
           text-align: left;
           display: none;
       }

       .action-btn {
           width: 100%;
           padding: 12px;
           border-radius: 10px;
           border: none;
           font-size: 15px;
           font-weight: 600;
           cursor: pointer;
           transition: 0.2s;
           margin-top: 10px;
       }

       .btn-primary { background: var(--primary-color); color: white; }
       .btn-primary:hover { background: var(--primary-hover); }
       .btn-outline { background: transparent; border: 1px solid #e2e8f0; color: #6b7280; margin-top: 8px; }
       .btn-outline:hover { border-color: #6b7280; color: var(--text-main); background: #f8fafc; }

       /* å‡†å¤‡å°±ç»ªé¢æ¿ */
       #ready-panel {
           display: none;
           text-align: center;
           width: 100%;
           max-width: 400px;
           animation: slideUp 0.3s ease;
       }

       .file-card {
           background: white;
           border: 1px solid #e2e8f0;
           border-radius: 16px;
           padding: 20px;
           margin-bottom: 20px;
           box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
       }

       .shuffle-options {
           background: #f8fafc;
           border: 1px solid #e2e8f0;
           border-radius: 12px;
           padding: 15px;
           margin-bottom: 15px;
           text-align: left;
       }

       .shuffle-options label { display: flex; align-items: center; margin: 8px 0; cursor: pointer; font-size: 14px; color: var(--text-secondary); }
       .shuffle-options input[type="checkbox"] { margin-right: 8px; width: 16px; height: 16px; accent-color: var(--primary-color); }

       /* ç­”é¢˜é¡µé¢ */
       .quiz-content {
           flex: 1;
           padding: 20px 30px;
           overflow-y: auto;
       }

       @media (min-width: 768px) {
           .quiz-layout-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; height: 100%; }
           .quiz-left-panel { border-right: 1px solid #eee; padding-right: 20px; display: flex; flex-direction: column; }
           .quiz-right-panel { padding-left: 10px; overflow-y: auto; }
           .question-text { font-size: 20px; }
       }

       @media (max-width: 767px) {
           .quiz-layout-wrapper { display: flex; flex-direction: column; }
           .question-text { font-size: 17px; }
       }

       .quiz-meta-info { color: #888; font-size: 13px; margin-bottom: 10px; }
       .quiz-meta-info #progressText { color: var(--primary-color); font-weight: bold; }
       .question-text { line-height: 1.6; margin-bottom: 20px; font-weight: 600; color: #222; }
       .options-list { display: flex; flex-direction: column; gap: 12px; }
       .option-item {
           background-color: #f7f8fa;
           padding: 16px 20px;
           border-radius: 12px;
           font-size: 16px;
           cursor: pointer;
           border: 2px solid transparent;
           transition: all 0.2s;
       }
       .option-item:hover:not(.disabled) { background-color: #ebedf0; }
       .option-item.correct { background-color: var(--correct-color); color: var(--correct-text); border-color: var(--correct-text); font-weight: 500; }
       .option-item.wrong { background-color: var(--wrong-color); color: var(--wrong-text); border-color: var(--wrong-text); }
       .disabled { pointer-events: none; }
       .analysis-box {
           margin-top: 20px;
           padding: 15px;
           background-color: #fff8e1;
           border-radius: 8px;
           font-size: 14px;
           color: #666;
           display: none;
           line-height: 1.6;
           border: 1px solid #ffeeba;
       }

       .quiz-footer {
           padding: 20px 30px;
           border-top: 1px solid #f0f0f0;
           background: #fff;
           display: flex;
           gap: 20px;
           flex-shrink: 0;
       }

       .nav-btn {
           flex: 1;
           padding: 14px;
           border-radius: 30px;
           font-size: 16px;
           font-weight: 700;
           border: none;
           cursor: pointer;
           transition: background-color 0.2s;
       }

       .btn-prev { background-color: #f5f5f5; color: #666; }
       .btn-prev:hover { background-color: #e9e9e9; }
       .btn-next { background-color: var(--primary-color); color: white; }
       .btn-next:hover { background-color: var(--primary-hover); }

       /* ç»“æœé¡µ */
       .result-layout {
           flex: 1;
           padding: 30px;
           overflow-y: auto;
           display: flex;
           flex-direction: column;
           align-items: center;
       }

       .score-circle-box { position: relative; width: 140px; height: 140px; margin-bottom: 20px; }
       .circle-bg { fill: none; stroke: #f1f5f9; stroke-width: 5; }
       .circle-bar { fill: none; stroke: var(--primary-color); stroke-width: 5; stroke-linecap: round; stroke-dasharray: 377; stroke-dashoffset: 377; transition: stroke-dashoffset 1s ease; }
       .score-val { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; font-weight: 800; color: var(--text-main); }

       .result-grid {
           display: grid;
           grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
           gap: 8px;
           width: 100%;
           max-width: 400px;
           margin-top: 10px;
       }

       .grid-dot {
           aspect-ratio: 1;
           border-radius: 6px;
           font-size: 12px;
           font-weight: 600;
           display: flex;
           align-items: center;
           justify-content: center;
           background: #f1f5f9;
           color: #94a3b8;
           cursor: pointer;
           transition: 0.2s;
       }
       .grid-dot:hover { transform: scale(1.1); }
       .grid-dot.correct { background: var(--correct-color); color: var(--correct-text); }
       .grid-dot.wrong { background: var(--wrong-color); color: var(--wrong-text); }

       .hidden { display: none; }
   </style>
</head>
<body>
   <div class="container">
       <!-- é¦–é¡µ -->
       <div id="homeView" class="view-section active">
           <div class="home-layout">
               <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“</div>
               <h2 style="margin: 0 0 24px 0; color: var(--text-main); font-size: 20px;">æç®€ç­”é¢˜ Pro</h2>
               
               <div id="setup-panel">
                   <!-- ä¸»Tabï¼šæ–‡ä»¶ vs ç²˜è´´ -->
                   <div class="tab-group">
                       <button class="tab-btn active" onclick="setTab('file')">ğŸ“ æ–‡ä»¶å¯¼å…¥</button>
                       <button class="tab-btn" onclick="setTab('paste')">ğŸ“‹ æ–‡æœ¬ç²˜è´´</button>
                   </div>

                   <!-- æ–‡ä»¶å¯¼å…¥åŒºåŸŸ -->
                   <div id="area-file" class="input-area active">
                       <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                           <div class="upload-icon">ğŸ“‚</div>
                           <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½è‡³æ­¤</div>
                           <div class="upload-hint">æ”¯æŒ .txt .json æ ¼å¼</div>
                       </div>
                       <input type="file" id="fileInput" accept=".txt,.json" class="hidden" onchange="handleFileSelect(event)">
                       <div id="fileError" class="error-msg"></div>
                   </div>

                   <!-- æ–‡æœ¬ç²˜è´´åŒºåŸŸ -->
                   <div id="area-paste" class="input-area">
                       <!-- å­Tabï¼šé¢„è®¾/è‡ªå®šä¹‰ -->
                       <div class="sub-tab">
                           <button class="sub-tab-btn active" onclick="setSubTab('preset')">ğŸ¯ é¢„è®¾æ ¼å¼</button>
                           <button class="sub-tab-btn" onclick="setSubTab('custom')">âš™ï¸ è‡ªå®šä¹‰æ ¼å¼</button>
                       </div>

                       <!-- é¢„è®¾æ ¼å¼é¢æ¿ -->
                       <div id="sub-preset" class="input-area active">
                           <div class="preset-list" id="presetList"></div>
                           <textarea id="presetInput" class="paste-box" placeholder="é€‰æ‹©ä¸Šæ–¹æ ¼å¼åï¼Œç²˜è´´é¢˜ç›®åˆ°æ­¤å¤„..."></textarea>
                           <button class="action-btn btn-primary" onclick="parseWithSelectedPreset()">è§£æé¢˜ç›®</button>
                       </div>

                       <!-- è‡ªå®šä¹‰æ ¼å¼é¢æ¿ -->
                       <div id="sub-custom" class="input-area">
                           <div class="custom-format-container">
                               <!-- æ¨¡å¼åˆ‡æ¢ -->
                               <div class="custom-mode-switch">
                                   <div class="mode-btn active" onclick="setCustomMode('simple')">
                                       ğŸ¨ ç®€å•æ¨¡å¼
                                       <span class="mode-desc">é€‚åˆåˆå­¦è€…</span>
                                   </div>
                                   <div class="mode-btn" onclick="setCustomMode('advanced')">
                                       ğŸ”§ é«˜çº§æ¨¡å¼
                                       <span class="mode-desc">æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼</span>
                                   </div>
                               </div>

                               <!-- ç®€å•æ¨¡å¼ -->
                               <div class="custom-simple-mode active">
                                   <div class="simple-format-builder">
                                       <div class="format-field">
                                           <label>
                                               æ ¼å¼åç§°
                                               <span class="help-icon" title="ç»™ä½ çš„æ ¼å¼èµ·ä¸ªåå­—">?</span>
                                           </label>
                                           <input type="text" id="simpleFormatName" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„è€ƒè¯•æ ¼å¼">
                                       </div>

                                       <div class="format-field">
                                           <label>
                                               é¢˜ç›®å¼€å§‹æ ‡è®°
                                               <span class="help-icon" title="é¢˜ç›®å‰é¢çš„æ ‡è®°ç¬¦å·">?</span>
                                           </label>
                                           <input type="text" id="simpleQuestionMarker" placeholder="ä¾‹å¦‚ï¼šé¢˜ç›®: æˆ– Q:">
                                           <div class="format-field-help">å¸¸è§æ ¼å¼ï¼š</div>
                                           <div class="quick-templates">
                                               <div class="template-chip" onclick="fillTemplate('question', 'Q:')">Q:</div>
                                               <div class="template-chip" onclick="fillTemplate('question', 'é¢˜ç›®:')">é¢˜ç›®:</div>
                                               <div class="template-chip" onclick="fillTemplate('question', 'ã€é¢˜ã€‘')">ã€é¢˜ã€‘</div>
                                               <div class="template-chip" onclick="fillTemplate('question', '1.')">åºå·</div>
                                           </div>
                                       </div>

                                       <div class="format-field">
                                           <label>
                                               é€‰é¡¹æ ¼å¼
                                               <span class="help-icon" title="é€‰é¡¹çš„æ ‡è®°æ–¹å¼">?</span>
                                           </label>
                                           <input type="text" id="simpleOptionMarker" placeholder="ä¾‹å¦‚ï¼šA. æˆ– (A)">
                                           <div class="format-field-help">å¸¸è§æ ¼å¼ï¼š</div>
                                           <div class="quick-templates">
                                               <div class="template-chip" onclick="fillTemplate('option', 'A.')">A.</div>
                                               <div class="template-chip" onclick="fillTemplate('option', 'A:')">A:</div>
                                               <div class="template-chip" onclick="fillTemplate('option', '(A)')>(A)</div>
                                               <div class="template-chip" onclick="fillTemplate('option', 'ã€Aã€‘')">ã€Aã€‘</div>
                                           </div>
                                       </div>

                                       <div class="format-field">
                                           <label>
                                               ç­”æ¡ˆæ ‡è®°
                                               <span class="help-icon" title="æ­£ç¡®ç­”æ¡ˆå‰çš„æ ‡è®°">?</span>
                                           </label>
                                           <input type="text" id="simpleAnswerMarker" placeholder="ä¾‹å¦‚ï¼šç­”æ¡ˆ: æˆ– æ­£ç¡®ç­”æ¡ˆ:">
                                           <div class="format-field-help">å¸¸è§æ ¼å¼ï¼š</div>
                                           <div class="quick-templates">
                                               <div class="template-chip" onclick="fillTemplate('answer', 'ç­”æ¡ˆ:')">ç­”æ¡ˆ:</div>
                                               <div class="template-chip" onclick="fillTemplate('answer', 'Answer:')">Answer:</div>
                                               <div class="template-chip" onclick="fillTemplate('answer', 'æ­£ç¡®:')">æ­£ç¡®:</div>
                                           </div>
                                       </div>

                                       <div class="format-field">
                                           <label>
                                               è§£ææ ‡è®°ï¼ˆå¯é€‰ï¼‰
                                               <span class="help-icon" title="ç­”æ¡ˆè§£æå‰çš„æ ‡è®°ï¼Œæ²¡æœ‰å¯ä¸å¡«">?</span>
                                           </label>
                                           <input type="text" id="simpleExplanationMarker" placeholder="ä¾‹å¦‚ï¼šè§£æ: æˆ– æ³¨é‡Š:">
                                           <div class="format-field-help">å¸¸è§æ ¼å¼ï¼š</div>
                                           <div class="quick-templates">
                                               <div class="template-chip" onclick="fillTemplate('explanation', 'è§£æ:')">è§£æ:</div>
                                               <div class="template-chip" onclick="fillTemplate('explanation', 'Explanation:')">Explanation:</div>
                                               <div class="template-chip" onclick="fillTemplate('explanation', 'æ³¨:')">æ³¨:</div>
                                           </div>
                                       </div>

                                       <div class="format-field">
                                           <label>
                                               é¢˜ç›®åˆ†éš”ç¬¦
                                               <span class="help-icon" title="ç”¨æ¥åˆ†éš”ä¸åŒé¢˜ç›®çš„ç¬¦å·">?</span>
                                           </label>
                                           <input type="text" id="simpleSeparator" placeholder="ä¾‹å¦‚ï¼š--- æˆ– ===">
                                           <div class="format-field-help">å¸¸è§æ ¼å¼ï¼š</div>
                                           <div class="quick-templates">
                                               <div class="template-chip" onclick="fillTemplate('separator', '---')">---</div>
                                               <div class="template-chip" onclick="fillTemplate('separator', '===')">===</div>
                                               <div class="template-chip" onclick="fillTemplate('separator', '###')">###</div>
                                               <div class="template-chip" onclick="fillTemplate('separator', 'ç©ºè¡Œ')">ç©ºè¡Œ</div>
                                           </div>
                                       </div>

                                       <button class="action-btn btn-primary" onclick="saveSimpleFormat()">ğŸ’¾ ä¿å­˜æ ¼å¼</button>
                                   </div>
                               </div>

                               <!-- é«˜çº§æ¨¡å¼ -->
                               <div class="custom-advanced-mode">
                                   <div class="advanced-format-editor">
                                       <div class="format-field">
                                           <label>æ ¼å¼åç§°</label>
                                           <input type="text" id="advancedFormatName" placeholder="æ ¼å¼åç§°">
                                       </div>

                                       <div class="regex-field">
                                           <label>é¢˜ç›®æ­£åˆ™è¡¨è¾¾å¼</label>
                                           <div class="regex-input-group">
                                               <input type="text" class="format-field input regex-input" id="advancedQuestionRegex" placeholder="ä¾‹å¦‚ï¼š^Q[:|ï¼š]\s*(.+)">
                                           </div>
                                           <div class="format-field-help">æ•è·ç»„ (.*) ä¼šæå–é¢˜ç›®å†…å®¹</div>
                                       </div>

                                       <div class="regex-field">
                                           <label>é€‰é¡¹æ­£åˆ™è¡¨è¾¾å¼</label>
                                           <input type="text" class="format-field input regex-input" id="advancedOptionRegex" placeholder="ä¾‹å¦‚ï¼š^[A-D][.:|ï¼š]\s*(.+)">
                                           <div class="format-field-help">æ•è·ç»„ (.*) ä¼šæå–é€‰é¡¹å†…å®¹</div>
                                       </div>

                                       <div class="regex-field">
                                           <label>ç­”æ¡ˆæ­£åˆ™è¡¨è¾¾å¼</label>
                                           <input type="text" class="format-field input regex-input" id="advancedAnswerRegex" placeholder="ä¾‹å¦‚ï¼š^ç­”æ¡ˆ[:|ï¼š]\s*([A-D])">
                                           <div class="format-field-help">æ•è·ç»„ (.*) ä¼šæå–ç­”æ¡ˆ</div>
                                       </div>

                                       <div class="regex-field">
                                           <label>è§£ææ­£åˆ™è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼‰</label>
                                           <input type="text" class="format-field input regex-input" id="advancedExplanationRegex" placeholder="ä¾‹å¦‚ï¼š^è§£æ[:|ï¼š]\s*(.+)">
                                       </div>

                                       <div class="format-field">
                                           <label>é¢˜ç›®åˆ†éš”ç¬¦æ­£åˆ™</label>
                                           <input type="text" class="format-field input regex-input" id="advancedSeparator" placeholder="ä¾‹å¦‚ï¼š^-{3,}$">
                                       </div>

                                       <button class="action-btn btn-primary" onclick="saveAdvancedFormat()">ğŸ’¾ ä¿å­˜é«˜çº§æ ¼å¼</button>
                                   </div>
                               </div>

                               <!-- å·²ä¿å­˜çš„æ ¼å¼ -->
                               <div class="saved-formats">
                                   <div class="saved-formats-title">ğŸ“š æˆ‘çš„æ ¼å¼åº“</div>
                                   <div id="savedFormatsList"></div>
                               </div>
                           </div>
                       </div>

                       <div id="pasteError" class="error-msg"></div>
                   </div>
               </div>

               <!-- å‡†å¤‡å°±ç»ªé¢æ¿ -->
               <div id="ready-panel">
                   <div class="file-card">
                       <div style="color: var(--correct-text); font-size: 24px; margin-bottom: 8px;">âœ“</div>
                       <div style="font-weight: 600; margin-bottom: 4px;">é¢˜åº“å·²åŠ è½½</div>
                       <div style="color: var(--text-secondary); font-size: 13px;">å…± <span id="qCount">0</span> é“é¢˜ç›®</div>
                   </div>
                   <div class="shuffle-options">
                       <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-main);">ğŸ² ç­”é¢˜è®¾ç½®</div>
                       <label><input type="checkbox" id="shuffleQuestions" checked> æ‰“ä¹±é¢˜ç›®é¡ºåº</label>
                       <label><input type="checkbox" id="shuffleOptions" checked> æ‰“ä¹±é€‰é¡¹é¡ºåº</label>
                   </div>
                   <button class="action-btn btn-primary" onclick="startQuiz()">å¼€å§‹ç­”é¢˜</button>
                   <button class="action-btn btn-outline" onclick="resetImport()">é‡æ–°å¯¼å…¥</button>
               </div>
           </div>
       </div>

       <!-- ç­”é¢˜é¡µ -->
       <div id="quizView" class="view-section">
           <div class="header">
               <span class="back-icon" onclick="confirmExit()">â†</span>
               <span>ç­”é¢˜ä¸­</span>
           </div>
           <div class="quiz-content">
               <div class="quiz-layout-wrapper">
                   <div class="quiz-left-panel">
                       <div class="quiz-meta-info">é¢˜ç›® <span id="progressText">1/10</span></div>
                       <div class="question-text" id="questionText">é¢˜ç›®åŠ è½½ä¸­...</div>
                   </div>
                   <div class="quiz-right-panel">
                       <div class="options-list" id="optionsContainer"></div>
                       <div class="analysis-box" id="analysisBox">
                           <div style="font-weight:bold; margin-bottom:5px; color:var(--text-main)">ğŸ’¡ è§£æï¼š</div>
                           <div id="analysisContent"></div>
                       </div>
                   </div>
               </div>
           </div>
           <div class="quiz-footer">
               <button class="nav-btn btn-prev" id="prevBtn" onclick="prevQ()">ä¸Šä¸€é¢˜</button>
               <button class="nav-btn btn-next" id="nextBtn" onclick="nextQ()">ä¸‹ä¸€é¢˜</button>
           </div>
       </div>

       <!-- ç»“æœé¡µ -->
       <div id="resultView" class="view-section">
           <div class="header">
               <div style="width:100%; text-align:center;">ç»“æœæ¦‚è§ˆ</div>
           </div>
           <div class="result-layout">
               <div class="score-circle-box">
                   <svg width="140" height="140" viewBox="0 0 140 140">
                       <circle class="circle-bg" cx="70" cy="70" r="60"></circle>
                       <circle class="circle-bar" id="scoreCircle" cx="70" cy="70" r="60"></circle>
                   </svg>
                   <div class="score-val"><span id="scoreVal">0</span><span style="font-size:14px; color:#999">%</span></div>
               </div>
               <div style="font-size:13px; color:var(--text-secondary); margin-bottom:15px;">é¢˜ç›®å›é¡¾ï¼ˆç‚¹å‡»å¯æŸ¥çœ‹ï¼‰</div>
               <div class="result-grid" id="resultGrid"></div>
               <button class="action-btn btn-outline" style="margin-top: 40px;" onclick="resetImport()">â† è¿”å›é¦–é¡µ</button>
           </div>
       </div>
   </div>

   <!-- ä¾‹é¢˜æ¨¡æ€æ¡† -->
   <div class="modal-overlay" id="exampleModal">
       <div class="modal-content">
           <div class="modal-header">
               <div class="modal-title" id="modalTitle">æ ¼å¼ç¤ºä¾‹</div>
               <div class="modal-close" onclick="closeExampleModal()">Ã—</div>
           </div>
           <div class="modal-body" id="modalBody"></div>
       </div>
   </div>

   <script>
       let questions = [];
       let originalQuestions = [];
       let userAnswers = [];
       let currentIndex = 0;
       let isReviewMode = false;
       let selectedPreset = null;
       let currentCustomMode = 'simple';

       // ========== é¢„è®¾æ ¼å¼åº“ï¼ˆå¸¦ä¾‹é¢˜ï¼‰ ==========
       const PRESET_FORMATS = [
           {
               id: 'default',
               name: 'æ ‡å‡†æ ¼å¼',
               desc: 'æœ€å¸¸ç”¨çš„ Q:/A-D:/ç­”æ¡ˆ: æ ¼å¼',
               example: `Q: ä»¥ä¸‹å“ªä¸ªæ˜¯ Python çš„ç‰¹ç‚¹ï¼Ÿ
A: ç¼–è¯‘å‹è¯­è¨€
B: è§£é‡Šå‹è¯­è¨€
C: æ±‡ç¼–è¯­è¨€
D: æœºå™¨è¯­è¨€
ç­”æ¡ˆ: B
è§£æ: Python æ˜¯ä¸€ç§è§£é‡Šå‹ã€é¢å‘å¯¹è±¡çš„é«˜çº§ç¼–ç¨‹è¯­è¨€
---
Q: HTTP é»˜è®¤ç«¯å£å·æ˜¯å¤šå°‘ï¼Ÿ
A: 80
B: 443
C: 8080
D: 3306
ç­”æ¡ˆ: A
è§£æ: HTTP é»˜è®¤ä½¿ç”¨ 80 ç«¯å£ï¼ŒHTTPS ä½¿ç”¨ 443 ç«¯å£`,
               config: {
                   questionMarkers: ['Q:', 'q:'],
                   optionPattern: '^[A-D]:\\s*',
                   answerMarkers: ['ç­”æ¡ˆ:', 'answer:', 'Answer:'],
                   explanationMarkers: ['è§£æ:', 'explain:', 'explanation:'],
                   separators: ['---', '===']
               }
           },
           {
               id: 'numbered',
               name: 'åºå·æ ¼å¼',
               desc: 'ä½¿ç”¨æ•°å­—ç¼–å·çš„é¢˜ç›®æ ¼å¼',
               example: `1. è®¡ç®—æœºçš„æ ¸å¿ƒéƒ¨ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ
A. ç¡¬ç›˜
B. CPU
C. å†…å­˜
D. æ˜¾å¡
ç­”æ¡ˆ: B
è§£æ: CPUï¼ˆä¸­å¤®å¤„ç†å™¨ï¼‰æ˜¯è®¡ç®—æœºçš„æ ¸å¿ƒéƒ¨ä»¶
---
2. ä»¥ä¸‹å“ªä¸ªæ˜¯å‰ç«¯æ¡†æ¶ï¼Ÿ
A. Django
B. Spring
C. React
D. Flask
ç­”æ¡ˆ: C
è§£æ: React æ˜¯æµè¡Œçš„å‰ç«¯ JavaScript åº“`,
               config: {
                   questionPattern: '^\\d+[.ã€]\\s*',
                   optionPattern: '^[A-D][.ã€]\\s*',
                   answerMarkers: ['ç­”æ¡ˆ:', 'æ­£ç¡®ç­”æ¡ˆ:'],
                   explanationMarkers: ['è§£æ:', 'æ³¨:'],
                   separators: ['---', '\\n\\n']
               }
           },
           {
               id: 'bracket',
               name: 'æ‹¬å·æ ¼å¼',
               desc: 'ä½¿ç”¨æ‹¬å·æ ‡è®°çš„æ ¼å¼',
               example: `ã€é¢˜ç›®ã€‘æ•°æ®åº“ä¸­ä¸»é”®çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
ï¼ˆAï¼‰æé«˜æŸ¥è¯¢é€Ÿåº¦
ï¼ˆBï¼‰å”¯ä¸€æ ‡è¯†è®°å½•
ï¼ˆCï¼‰èŠ‚çœå­˜å‚¨ç©ºé—´
ï¼ˆDï¼‰åŠ å¯†æ•°æ®
ã€ç­”æ¡ˆã€‘B
ã€è§£æã€‘ä¸»é”®ç”¨äºå”¯ä¸€æ ‡è¯†è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•
---
ã€é¢˜ç›®ã€‘ä»¥ä¸‹å“ªä¸ªä¸æ˜¯é¢å‘å¯¹è±¡çš„ç‰¹æ€§ï¼Ÿ
ï¼ˆAï¼‰å°è£…
ï¼ˆBï¼‰ç»§æ‰¿
ï¼ˆCï¼‰å¤šæ€
ï¼ˆDï¼‰ç¼–è¯‘
ã€ç­”æ¡ˆã€‘D`,
               config: {
                   questionMarkers: ['ã€é¢˜ç›®ã€‘', 'ã€é¢˜ã€‘'],
                   optionPattern: '^[ï¼ˆ(][A-D][)ï¼‰]\\s*',
                   answerMarkers: ['ã€ç­”æ¡ˆã€‘', 'ã€æ­£ç¡®ç­”æ¡ˆã€‘'],
                   explanationMarkers: ['ã€è§£æã€‘', 'ã€æ³¨é‡Šã€‘'],
                   separators: ['---', '===']
               }
           },
           {
               id: 'english',
               name: 'English Format',
               desc: 'Standard English question format',
               example: `Question: What does HTML stand for?
A. Hyper Text Markup Language
B. High Tech Modern Language
C. Home Tool Markup Language
D. Hyperlinks and Text Markup Language
Answer: A
Explanation: HTML stands for Hyper Text Markup Language
---
Question: Which is a JavaScript framework?
A. Laravel
B. Django
C. Vue.js
D. Ruby on Rails
Answer: C
Explanation: Vue.js is a progressive JavaScript framework`,
               config: {
                   questionMarkers: ['Question:', 'Q:'],
                   optionPattern: '^[A-D][.:]\\s*',
                   answerMarkers: ['Answer:', 'Correct:'],
                   explanationMarkers: ['Explanation:', 'Note:'],
                   separators: ['---', '===']
               }
           },
           {
               id: 'chinese_simple',
               name: 'ç®€æ´ä¸­æ–‡',
               desc: 'æç®€çš„ä¸­æ–‡æ ¼å¼ï¼Œæ— æ ‡è®°ç¬¦å·',
               example: `ä»€ä¹ˆæ˜¯ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ï¼Ÿ
A. ç®—æ³•æ‰§è¡Œæ‰€éœ€çš„æ—¶é—´
B. ç®—æ³•å ç”¨çš„å­˜å‚¨ç©ºé—´
C. ç®—æ³•æ‰§è¡Œæ¬¡æ•°çš„æ•°é‡çº§
D. ç®—æ³•çš„ä»£ç è¡Œæ•°
ç­”æ¡ˆ: C
è§£æ: æ—¶é—´å¤æ‚åº¦æè¿°ç®—æ³•æ‰§è¡Œæ¬¡æ•°éšè¾“å…¥è§„æ¨¡å¢é•¿çš„è¶‹åŠ¿
---
æ ˆçš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
A. å…ˆè¿›å…ˆå‡º
B. åè¿›å…ˆå‡º
C. éšæœºå­˜å–
D. é¡ºåºå­˜å–
ç­”æ¡ˆ: B`,
               config: {
                   questionPattern: '^[^A-D\\s].*[ï¼Ÿ?]$',
                   optionPattern: '^[A-D][.ã€:]\\s*',
                   answerMarkers: ['ç­”æ¡ˆ:', 'ç­”:', 'answer:'],
                   explanationMarkers: ['è§£æ:', 'æ³¨:', 'explain:'],
                   separators: ['---', '===', '\\n\\n']
               }
           }
       ];

       // ========== åˆå§‹åŒ– ==========
       function init() {
           loadCustomFormats();
           renderPresets();
       }

       // ========== ç•Œé¢åˆ‡æ¢ ==========
       function setTab(mode) {
           const btns = document.querySelectorAll('.tab-group .tab-btn');
           btns.forEach(b => b.classList.remove('active'));
           
           if (mode === 'file') {
               btns[0].classList.add('active');
               document.getElementById('area-file').classList.add('active');
               document.getElementById('area-paste').classList.remove('active');
           } else {
               btns[1].classList.add('active');
               document.getElementById('area-file').classList.remove('active');
               document.getElementById('area-paste').classList.add('active');
           }
           hideErrors();
       }

       function setSubTab(mode) {
           document.querySelectorAll('#area-paste .sub-tab-btn').forEach(b => b.classList.remove('active'));
           document.querySelectorAll('#area-paste > .input-area').forEach(a => a.classList.remove('active'));
           
           const tabs = document.querySelectorAll('#area-paste .sub-tab-btn');
           if (mode === 'preset') {
               tabs[0].classList.add('active');
               document.getElementById('sub-preset').classList.add('active');
           } else {
               tabs[1].classList.add('active');
               document.getElementById('sub-custom').classList.add('active');
           }
           hideErrors();
       }

       function setCustomMode(mode) {
           currentCustomMode = mode;
           document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
           document.querySelector(`.mode-btn:nth-child(${mode === 'simple' ? 1 : 2})`).classList.add('active');
           
           document.querySelector('.custom-simple-mode').classList.toggle('active', mode === 'simple');
           document.querySelector('.custom-advanced-mode').classList.toggle('active', mode === 'advanced');
       }

       function hideErrors() {
           document.getElementById('fileError').style.display = 'none';
           document.getElementById('pasteError').style.display = 'none';
       }

       // ========== é¢„è®¾æ ¼å¼æ¸²æŸ“ ==========
       function renderPresets() {
           const container = document.getElementById('presetList');
           container.innerHTML = '';
           
           PRESET_FORMATS.forEach(preset => {
               const card = document.createElement('div');
               card.className = 'preset-card';
               card.onclick = (e) => {
                   if (!e.target.classList.contains('preset-card-example-btn')) {
                       selectPreset(preset.id);
                   }
               };
               card.innerHTML = `
                   <div class="preset-card-title">${preset.name}</div>
                   <div class="preset-card-desc">${preset.desc}</div>
                   <div class="preset-card-example-btn" onclick="showExample('${preset.id}', event)">ğŸ“– æŸ¥çœ‹ä¾‹é¢˜</div>
               `;
               container.appendChild(card);
           });
           
           // æ·»åŠ è‡ªå®šä¹‰æ ¼å¼å¡ç‰‡
           const customFormats = getCustomFormats();
           customFormats.forEach(format => {
               const card = document.createElement('div');
               card.className = 'preset-card';
               card.style.borderColor = '#d1fae5';
               card.onclick = () => selectPreset(format.id);
               card.innerHTML = `
                   <div class="preset-card-title">âœ¨ ${format.name}</div>
                   <div class="preset-card-desc">è‡ªå®šä¹‰æ ¼å¼ ${format.mode === 'advanced' ? '(é«˜çº§)' : ''}</div>
               `;
               container.appendChild(card);
           });
       }

       function selectPreset(id) {
           selectedPreset = id;
           const cards = document.querySelectorAll('.preset-card');
           cards.forEach(card => card.classList.remove('selected'));
           
           const allFormats = [...PRESET_FORMATS, ...getCustomFormats()];
           const index = allFormats.findIndex(f => f.id === id);
           if (index >= 0 && cards[index]) {
               cards[index].classList.add('selected');
           }
       }

       function showExample(presetId, event) {
           event.stopPropagation();
           const preset = PRESET_FORMATS.find(p => p.id === presetId);
           if (!preset || !preset.example) return;
           
           const modal = document.getElementById('exampleModal');
           const modalTitle = document.getElementById('modalTitle');
           const modalBody = document.getElementById('modalBody');
           
           modalTitle.textContent = `${preset.name} - æ ¼å¼ç¤ºä¾‹`;
           modalBody.innerHTML = `
               <div class="example-section">
                   <div class="example-title">ğŸ“ ç¤ºä¾‹é¢˜ç›®</div>
                   <div class="example-code">${preset.example}</div>
                   <button class="copy-example-btn" onclick="copyExample('${presetId}')">ğŸ“‹ å¤åˆ¶ç¤ºä¾‹</button>
               </div>
               <div class="example-section">
                   <div class="example-title">ğŸ’¡ æ ¼å¼è¯´æ˜</div>
                   <div style="font-size: 13px; line-height: 1.8; color: var(--text-secondary);">
                       ${getFormatDescription(preset)}
                   </div>
               </div>
           `;
           
           modal.classList.add('active');
       }

       function getFormatDescription(preset) {
           const lines = [];
           if (preset.config.questionMarkers) {
               lines.push(`â€¢ é¢˜ç›®æ ‡è®°: ${preset.config.questionMarkers.join(' æˆ– ')}`);
           }
           if (preset.config.questionPattern) {
               lines.push(`â€¢ é¢˜ç›®æ ¼å¼: ${preset.config.questionPattern}`);
           }
           if (preset.config.optionPattern) {
               lines.push(`â€¢ é€‰é¡¹æ ¼å¼: ${preset.config.optionPattern}`);
           }
           if (preset.config.answerMarkers) {
               lines.push(`â€¢ ç­”æ¡ˆæ ‡è®°: ${preset.config.answerMarkers.join(' æˆ– ')}`);
           }
           if (preset.config.explanationMarkers) {
               lines.push(`â€¢ è§£ææ ‡è®°: ${preset.config.explanationMarkers.join(' æˆ– ')} (å¯é€‰)`);
           }
           if (preset.config.separators) {
               lines.push(`â€¢ é¢˜ç›®åˆ†éš”: ${preset.config.separators.join(' æˆ– ')}`);
           }
           return lines.join('<br>');
       }

       function copyExample(presetId) {
           const preset = PRESET_FORMATS.find(p => p.id === presetId);
           if (!preset) return;
           
           navigator.clipboard.writeText(preset.example).then(() => {
               alert('ç¤ºä¾‹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
               closeExampleModal();
               // è‡ªåŠ¨é€‰ä¸­è¯¥é¢„è®¾å¹¶åˆ‡æ¢åˆ°ç²˜è´´æ¡†
               selectPreset(presetId);
               document.getElementById('presetInput').focus();
           });
       }

       function closeExampleModal() {
           document.getElementById('exampleModal').classList.remove('active');
       }

       // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
       document.getElementById('exampleModal').addEventListener('click', function(e) {
           if (e.target === this) closeExampleModal();
       });

       function parseWithSelectedPreset() {
           if (!selectedPreset) {
               showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ ¼å¼', 'paste');
               return;
           }
           
           const text = document.getElementById('presetInput').value.trim();
           if (!text) {
               showError('è¯·å…ˆç²˜è´´é¢˜ç›®å†…å®¹', 'paste');
               return;
           }
           
           const allFormats = [...PRESET_FORMATS, ...getCustomFormats()];
           const format = allFormats.find(f => f.id === selectedPreset);
           
           if (format) {
               if (format.mode === 'advanced') {
                   parseWithAdvancedFormat(text, format.config);
               } else {
                   parseWithSimpleFormat(text, format.config);
               }
           }
       }

       // ========== è‡ªå®šä¹‰æ ¼å¼ - ç®€å•æ¨¡å¼ ==========
       function fillTemplate(field, value) {
           const fieldMap = {
               'question': 'simpleQuestionMarker',
               'option': 'simpleOptionMarker',
               'answer': 'simpleAnswerMarker',
               'explanation': 'simpleExplanationMarker',
               'separator': 'simpleSeparator'
           };
           
           const inputId = fieldMap[field];
           if (inputId) {
               if (value === 'ç©ºè¡Œ') {
                   document.getElementById(inputId).value = '\\n\\n';
               } else if (value === 'åºå·') {
                   document.getElementById(inputId).value = '1.';
               } else {
                   document.getElementById(inputId).value = value;
               }
           }
       }

       function saveSimpleFormat() {
           const name = document.getElementById('simpleFormatName').value.trim();
           const questionMarker = document.getElementById('simpleQuestionMarker').value.trim();
           const optionMarker = document.getElementById('simpleOptionMarker').value.trim();
           const answerMarker = document.getElementById('simpleAnswerMarker').value.trim();
           const explanationMarker = document.getElementById('simpleExplanationMarker').value.trim();
           const separator = document.getElementById('simpleSeparator').value.trim();
           
           if (!name) {
               alert('è¯·è¾“å…¥æ ¼å¼åç§°');
               return;
           }
           if (!questionMarker && !optionMarker) {
               alert('è‡³å°‘éœ€è¦å¡«å†™é¢˜ç›®æ ‡è®°æˆ–é€‰é¡¹æ ¼å¼');
               return;
           }
           if (!answerMarker) {
               alert('è¯·å¡«å†™ç­”æ¡ˆæ ‡è®°');
               return;
           }
           if (!separator) {
               alert('è¯·å¡«å†™é¢˜ç›®åˆ†éš”ç¬¦');
               return;
           }
           
           const config = {
               questionMarkers: questionMarker ? [questionMarker] : [],
               optionPattern: convertToPattern(optionMarker),
               answerMarkers: [answerMarker],
               explanationMarkers: explanationMarker ? [explanationMarker] : [],
               separators: [separator === '\\n\\n' ? '\\n\\n' : separator]
           };
           
           saveFormatToStorage(name, config, 'simple');
           
           // æ¸…ç©ºè¾“å…¥
           document.getElementById('simpleFormatName').value = '';
           document.getElementById('simpleQuestionMarker').value = '';
           document.getElementById('simpleOptionMarker').value = '';
           document.getElementById('simpleAnswerMarker').value = '';
           document.getElementById('simpleExplanationMarker').value = '';
           document.getElementById('simpleSeparator').value = '';
           
           alert('æ ¼å¼å·²ä¿å­˜ï¼');
           loadCustomFormats();
           renderPresets();
       }

       function convertToPattern(marker) {
           // å°†ç®€å•æ ‡è®°è½¬æ¢ä¸ºæ­£åˆ™æ¨¡å¼
           if (marker.includes('(') && marker.includes(')')) {
               return '^[ï¼ˆ(][A-D][)ï¼‰]\\s*';
           } else if (marker.match(/^[A-D][.:]$/)) {
               const symbol = marker.charAt(1);
               return `^[A-D][${symbol}]\\s*`;
           } else if (marker.includes('ã€') && marker.includes('ã€‘')) {
               return '^ã€[A-D]ã€‘\\s*';
           }
           return `^[A-D][.:]\\s*`;
       }

       // ========== è‡ªå®šä¹‰æ ¼å¼ - é«˜çº§æ¨¡å¼ ==========
       function saveAdvancedFormat() {
           const name = document.getElementById('advancedFormatName').value.trim();
           const questionRegex = document.getElementById('advancedQuestionRegex').value.trim();
           const optionRegex = document.getElementById('advancedOptionRegex').value.trim();
           const answerRegex = document.getElementById('advancedAnswerRegex').value.trim();
           const explanationRegex = document.getElementById('advancedExplanationRegex').value.trim();
           const separator = document.getElementById('advancedSeparator').value.trim();
           
           if (!name || !questionRegex || !optionRegex || !answerRegex || !separator) {
               alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹');
               return;
           }
           
           // éªŒè¯æ­£åˆ™è¡¨è¾¾å¼
           try {
               new RegExp(questionRegex);
               new RegExp(optionRegex);
               new RegExp(answerRegex);
               if (explanationRegex) new RegExp(explanationRegex);
               new RegExp(separator);
           } catch (e) {
               alert('æ­£åˆ™è¡¨è¾¾å¼æ ¼å¼é”™è¯¯: ' + e.message);
               return;
           }
           
           const config = {
               questionPattern: questionRegex,
               optionPattern: optionRegex,
               answerPattern: answerRegex,
               explanationPattern: explanationRegex || null,
               separatorPattern: separator
           };
           
           saveFormatToStorage(name, config, 'advanced');
           
           // æ¸…ç©ºè¾“å…¥
           document.getElementById('advancedFormatName').value = '';
           document.getElementById('advancedQuestionRegex').value = '';
           document.getElementById('advancedOptionRegex').value = '';
           document.getElementById('advancedAnswerRegex').value = '';
           document.getElementById('advancedExplanationRegex').value = '';
           document.getElementById('advancedSeparator').value = '';
           
           alert('é«˜çº§æ ¼å¼å·²ä¿å­˜ï¼');
           loadCustomFormats();
           renderPresets();
       }

       // ========== æ ¼å¼å­˜å‚¨ç®¡ç† ==========
       function saveFormatToStorage(name, config, mode) {
           const customFormats = getCustomFormats();
           const newFormat = {
               id: 'custom_' + Date.now(),
               name: name,
               config: config,
               mode: mode,
               createdAt: new Date().toISOString()
           };
           
           customFormats.push(newFormat);
           localStorage.setItem('customFormats', JSON.stringify(customFormats));
       }

       function getCustomFormats() {
           try {
               return JSON.parse(localStorage.getItem('customFormats') || '[]');
           } catch {
               return [];
           }
       }

       function loadCustomFormats() {
           const formats = getCustomFormats();
           const container = document.getElementById('savedFormatsList');
           container.innerHTML = '';
           
           if (formats.length === 0) {
               container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">æš‚æ— ä¿å­˜çš„æ ¼å¼</div>';
               return;
           }
           
           formats.forEach(format => {
               const item = document.createElement('div');
               item.className = 'saved-format-item';
               item.innerHTML = `
                   <div class="saved-format-info">
                       <div class="saved-format-name">${format.name}</div>
                       <div class="saved-format-meta">${format.mode === 'advanced' ? 'é«˜çº§æ¨¡å¼' : 'ç®€å•æ¨¡å¼'} â€¢ ${new Date(format.createdAt).toLocaleDateString()}</div>
                   </div>
                   <div class="saved-format-actions">
                       <button class="icon-btn primary" onclick="useCustomFormat('${format.id}')">ä½¿ç”¨</button>
                       <button class="icon-btn" onclick="editCustomFormat('${format.id}')">ç¼–è¾‘</button>
                       <button class="icon-btn" onclick="deleteCustomFormat('${format.id}')">åˆ é™¤</button>
                   </div>
               `;
               container.appendChild(item);
           });
       }

       function useCustomFormat(id) {
           setSubTab('preset');
           selectPreset(id);
           document.getElementById('presetInput').focus();
       }

       function editCustomFormat(id) {
           const formats = getCustomFormats();
           const format = formats.find(f => f.id === id);
           if (!format) return;
           
           if (format.mode === 'simple') {
               setCustomMode('simple');
               document.getElementById('simpleFormatName').value = format.name;
               if (format.config.questionMarkers && format.config.questionMarkers[0]) {
                   document.getElementById('simpleQuestionMarker').value = format.config.questionMarkers[0];
               }
               if (format.config.answerMarkers && format.config.answerMarkers[0]) {
                   document.getElementById('simpleAnswerMarker').value = format.config.answerMarkers[0];
               }
               if (format.config.explanationMarkers && format.config.explanationMarkers[0]) {
                   document.getElementById('simpleExplanationMarker').value = format.config.explanationMarkers[0];
               }
               if (format.config.separators && format.config.separators[0]) {
                   document.getElementById('simpleSeparator').value = format.config.separators[0];
               }
           } else {
               setCustomMode('advanced');
               document.getElementById('advancedFormatName').value = format.name;
               document.getElementById('advancedQuestionRegex').value = format.config.questionPattern || '';
               document.getElementById('advancedOptionRegex').value = format.config.optionPattern || '';
               document.getElementById('advancedAnswerRegex').value = format.config.answerPattern || '';
               document.getElementById('advancedExplanationRegex').value = format.config.explanationPattern || '';
               document.getElementById('advancedSeparator').value = format.config.separatorPattern || '';
           }
           
           // åˆ é™¤åŸæ ¼å¼
           deleteCustomFormat(id, true);
       }

       function deleteCustomFormat(id, skipConfirm = false) {
           if (!skipConfirm && !confirm('ç¡®å®šåˆ é™¤æ­¤æ ¼å¼ï¼Ÿ')) return;
           
           let formats = getCustomFormats();
           formats = formats.filter(f => f.id !== id);
           localStorage.setItem('customFormats', JSON.stringify(formats));
           
           loadCustomFormats();
           renderPresets();
           
           if (selectedPreset === id) {
               selectedPreset = null;
           }
       }

       // ========== æ ¼å¼è§£æ ==========
       function parseWithSimpleFormat(text, config) {
           const separatorPattern = config.separators.map(s => 
               s === '\\n\\n' ? '\\n\\s*\\n' : s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
           ).join('|');
           
           const blocks = text.split(new RegExp(`(?:${separatorPattern})`)).filter(b => b.trim());
           
           if (blocks.length === 0) {
               showError('æœªæ‰¾åˆ°æœ‰æ•ˆé¢˜ç›®', 'paste');
               return false;
           }
           
           const parsed = [];
           const errors = [];
           
           for (let i = 0; i < blocks.length; i++) {
               const lines = blocks[i].split('\n').map(l => l.trim()).filter(l => l);
               if (lines.length === 0) continue;
               
               const q = { question: '', options: [], correctIndex: -1, explanation: '' };
               
               for (const line of lines) {
                   // åŒ¹é…é¢˜ç›®
                   if (config.questionMarkers && config.questionMarkers.length > 0) {
                       const qPattern = new RegExp(`^(?:${config.questionMarkers.map(m => m.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})\\s*`, 'i');
                       if (qPattern.test(line)) {
                           q.question = line.replace(qPattern, '');
                           continue;
                       }
                   }
                   
                   // åŒ¹é…é€‰é¡¹
                   if (config.optionPattern) {
                       const optPattern = new RegExp(config.optionPattern, 'i');
                       if (optPattern.test(line)) {
                           q.options.push(line.replace(optPattern, ''));
                           continue;
                       }
                   }
                   
                   // åŒ¹é…ç­”æ¡ˆ
                   if (config.answerMarkers) {
                       const ansPattern = new RegExp(`^(?:${config.answerMarkers.map(m => m.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})\\s*`, 'i');
                       if (ansPattern.test(line)) {
                           const ans = line.replace(ansPattern, '').trim();
                           if (/^[A-Da-d]$/.test(ans)) {
                               q.correctIndex = ans.toUpperCase().charCodeAt(0) - 65;
                           } else if (/^\d+$/.test(ans)) {
                               q.correctIndex = parseInt(ans);
                           }
                           continue;
                       }
                   }
                   
                   // åŒ¹é…è§£æ
                   if (config.explanationMarkers && config.explanationMarkers.length > 0) {
                       const explPattern = new RegExp(`^(?:${config.explanationMarkers.map(m => m.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})\\s*`, 'i');
                       if (explPattern.test(line)) {
                           q.explanation = line.replace(explPattern, '');
                           continue;
                       }
                   }
                   
                   // å¦‚æœæ²¡æœ‰é¢˜ç›®ï¼Œå°†å…¶ä½œä¸ºé¢˜ç›®
                   if (!q.question) {
                       q.question = line;
                   }
               }
               
               // éªŒè¯
               if (!q.question) errors.push(`ç¬¬${i+1}é¢˜ï¼šç¼ºå°‘é¢˜ç›®`);
               else if (q.options.length < 2) errors.push(`ç¬¬${i+1}é¢˜ï¼šé€‰é¡¹ä¸è¶³`);
               else if (q.correctIndex < 0 || q.correctIndex >= q.options.length) errors.push(`ç¬¬${i+1}é¢˜ï¼šç­”æ¡ˆæ— æ•ˆ`);
               else parsed.push(q);
           }
           
           if (errors.length > 0) {
               showError(errors.join('ï¼›'), 'paste');
               return false;
           }
           
           if (parsed.length > 0) {
               originalQuestions = parsed;
               showReady(parsed.length);
           }
           return parsed.length > 0;
       }

       function parseWithAdvancedFormat(text, config) {
           const blocks = text.split(new RegExp(config.separatorPattern, 'm')).filter(b => b.trim());
           
           if (blocks.length === 0) {
               showError('æœªæ‰¾åˆ°æœ‰æ•ˆé¢˜ç›®', 'paste');
               return false;
           }
           
           const parsed = [];
           const errors = [];
           
           for (let i = 0; i < blocks.length; i++) {
               const lines = blocks[i].split('\n').map(l => l.trim()).filter(l => l);
               if (lines.length === 0) continue;
               
               const q = { question: '', options: [], correctIndex: -1, explanation: '' };
               
               for (const line of lines) {
                   // åŒ¹é…é¢˜ç›®
                   const qMatch = line.match(new RegExp(config.questionPattern, 'i'));
                   if (qMatch) {
                       q.question = qMatch[1] || qMatch[0];
                       continue;
                   }
                   
                   // åŒ¹é…é€‰é¡¹
                   const optMatch = line.match(new RegExp(config.optionPattern, 'i'));
                   if (optMatch) {
                       q.options.push(optMatch[1] || optMatch[0]);
                       continue;
                   }
                   
                   // åŒ¹é…ç­”æ¡ˆ
                   const ansMatch = line.match(new RegExp(config.answerPattern, 'i'));
                   if (ansMatch) {
                       const ans = (ansMatch[1] || ansMatch[0]).trim();
                       if (/^[A-Da-d]$/.test(ans)) {
                           q.correctIndex = ans.toUpperCase().charCodeAt(0) - 65;
                       } else if (/^\d+$/.test(ans)) {
                           q.correctIndex = parseInt(ans);
                       }
                       continue;
                   }
                   
                   // åŒ¹é…è§£æ
                   if (config.explanationPattern) {
                       const explMatch = line.match(new RegExp(config.explanationPattern, 'i'));
                       if (explMatch) {
                           q.explanation = explMatch[1] || explMatch[0];
                           continue;
                       }
                   }
               }
               
               // éªŒè¯
               if (!q.question) errors.push(`ç¬¬${i+1}é¢˜ï¼šç¼ºå°‘é¢˜ç›®`);
               else if (q.options.length < 2) errors.push(`ç¬¬${i+1}é¢˜ï¼šé€‰é¡¹ä¸è¶³`);
               else if (q.correctIndex < 0 || q.correctIndex >= q.options.length) errors.push(`ç¬¬${i+1}é¢˜ï¼šç­”æ¡ˆæ— æ•ˆ`);
               else parsed.push(q);
           }
           
           if (errors.length > 0) {
               showError(errors.join('ï¼›'), 'paste');
               return false;
           }
           
           if (parsed.length > 0) {
               originalQuestions = parsed;
               showReady(parsed.length);
           }
           return parsed.length > 0;
       }

       // ========== æ–‡ä»¶å¯¼å…¥ ==========
       const uploadZone = document.getElementById('uploadZone');
       
       uploadZone.addEventListener('dragover', (e) => {
           e.preventDefault();
           uploadZone.classList.add('drag-over');
       });
       
       uploadZone.addEventListener('dragleave', () => {
           uploadZone.classList.remove('drag-over');
       });
       
       uploadZone.addEventListener('drop', (e) => {
           e.preventDefault();
           uploadZone.classList.remove('drag-over');
           const files = e.dataTransfer.files;
           if (files.length > 0) processFile(files[0]);
       });

       function handleFileSelect(e) {
           if (e.target.files.length > 0) processFile(e.target.files[0]);
       }

       function processFile(file) {
           const reader = new FileReader();
           reader.onload = (e) => {
               const content = e.target.result;
               try {
                   const json = JSON.parse(content);
                   parseImportData(json);
               } catch {
                   // å°è¯•ç”¨ç¬¬ä¸€ä¸ªé¢„è®¾æ ¼å¼è§£æ
                   parseWithSimpleFormat(content, PRESET_FORMATS[0].config);
               }
           };
           reader.onerror = () => showError('æ–‡ä»¶è¯»å–å¤±è´¥', 'file');
           reader.readAsText(file);
       }

       function parseImportData(data) {
           if (!Array.isArray(data)) {
               showError('JSONæ•°æ®å¿…é¡»ä¸ºæ•°ç»„æ ¼å¼', 'file');
               return false;
           }

           const parsed = [];
           const errors = [];

           for (let i = 0; i < data.length; i++) {
               const item = data[i];
               const q = { question: '', options: [], correctIndex: 0, explanation: '' };

               if (item.q !== undefined) {
                   q.question = item.q;
                   q.options = Array.isArray(item.o) ? item.o : [];
                   if (typeof item.a === 'string' && /^[A-Da-d]$/.test(item.a)) {
                       q.correctIndex = item.a.toUpperCase().charCodeAt(0) - 65;
                   } else {
                       q.correctIndex = parseInt(item.a) || 0;
                   }
                   q.explanation = item.e || '';
               } else if (item.question !== undefined) {
                   q.question = item.question;
                   q.options = Array.isArray(item.options) ? item.options : [];
                   if (typeof item.correctIndex === 'string' && /^[A-Da-d]$/.test(item.correctIndex)) {
                       q.correctIndex = item.correctIndex.toUpperCase().charCodeAt(0) - 65;
                   } else {
                       q.correctIndex = parseInt(item.correctIndex) || parseInt(item.answer) || 0;
                   }
                   q.explanation = item.explanation || item.explain || '';
               } else {
                   errors.push(`ç¬¬${i+1}é¡¹ï¼šç¼ºå°‘å¿…è¦çš„é¢˜ç›®å­—æ®µ`);
                   continue;
               }

               if (!q.question) errors.push(`ç¬¬${i+1}é¡¹ï¼šé¢˜ç›®å†…å®¹ä¸ºç©º`);
               else if (q.options.length < 2) errors.push(`ç¬¬${i+1}é¡¹ï¼šé€‰é¡¹ä¸è¶³2ä¸ª`);
               else if (q.correctIndex < 0 || q.correctIndex >= q.options.length) errors.push(`ç¬¬${i+1}é¡¹ï¼šç­”æ¡ˆç´¢å¼•è¶…å‡ºèŒƒå›´`);
               else parsed.push(q);
           }

           if (errors.length > 0) {
               showError(errors.join('ï¼›'), 'file');
               return false;
           }

           if (parsed.length > 0) {
               originalQuestions = parsed;
               showReady(parsed.length);
           }
           return parsed.length > 0;
       }

       // ========== è¾…åŠ©åŠŸèƒ½ ==========
       function showError(msg, type) {
           const el = type === 'file' ? document.getElementById('fileError') : document.getElementById('pasteError');
           el.textContent = msg;
           el.style.display = 'block';
           setTimeout(() => { el.style.display = 'none'; }, 8000);
       }

       function showReady(count) {
           document.getElementById('qCount').innerText = count;
           document.getElementById('setup-panel').style.display = 'none';
           document.getElementById('ready-panel').style.display = 'block';
       }

       function resetImport() {
           originalQuestions = [];
           questions = [];
           userAnswers = [];
           currentIndex = 0;
           isReviewMode = false;
           selectedPreset = null;
           
           document.getElementById('fileInput').value = '';
           document.getElementById('presetInput').value = '';
           
           document.getElementById('setup-panel').style.display = 'block';
           document.getElementById('ready-panel').style.display = 'none';
           hideErrors();
           switchView('homeView');
       }

       function switchView(id) {
           document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
           document.getElementById(id).classList.add('active');
       }

       // ========== ç­”é¢˜é€»è¾‘ ==========
       function shuffleArray(arr) {
           const newArr = [...arr];
           for (let i = newArr.length - 1; i > 0; i--) {
               const j = Math.floor(Math.random() * (i + 1));
               [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
           }
           return newArr;
       }

       function startQuiz() {
           questions = JSON.parse(JSON.stringify(originalQuestions));

           if (document.getElementById('shuffleQuestions').checked) {
               questions = shuffleArray(questions);
           }

           if (document.getElementById('shuffleOptions').checked) {
               questions.forEach(q => {
                   const correctContent = q.options[q.correctIndex];
                   q.options = shuffleArray(q.options);
                   q.correctIndex = q.options.indexOf(correctContent);
               });
           }

           userAnswers = new Array(questions.length).fill(null);
           currentIndex = 0;
           isReviewMode = false;
           renderQuestion();
           switchView('quizView');
       }

       function renderQuestion() {
           const q = questions[currentIndex];
           const record = userAnswers[currentIndex];

           document.getElementById('progressText').innerText = `${currentIndex + 1} / ${questions.length}`;
           document.getElementById('questionText').innerText = q.question;

           const container = document.getElementById('optionsContainer');
           container.innerHTML = '';
           document.getElementById('analysisBox').style.display = 'none';

           q.options.forEach((opt, idx) => {
               const btn = document.createElement('div');
               btn.className = 'option-item';
               btn.innerText = String.fromCharCode(65 + idx) + '. ' + opt;

               if (record) {
                   btn.classList.add('disabled');
                   if (idx === q.correctIndex) btn.classList.add('correct');
                   if (idx === record.selectedIndex && idx !== q.correctIndex) btn.classList.add('wrong');
               } else {
                   btn.onclick = () => handleAnswer(idx, btn);
               }
               container.appendChild(btn);
           });

           if (record && q.explanation) showAnalysis(q.explanation);
           updateNavButtons();
       }

       function handleAnswer(idx, el) {
           const q = questions[currentIndex];
           const isCorrect = idx === q.correctIndex;
           userAnswers[currentIndex] = { selectedIndex: idx, isCorrect };

           const allOpts = document.querySelectorAll('.option-item');
           allOpts.forEach(o => o.classList.add('disabled'));

           if (isCorrect) {
               el.classList.add('correct');
           } else {
               el.classList.add('wrong');
               allOpts[q.correctIndex].classList.add('correct');
           }

           if (q.explanation) showAnalysis(q.explanation);
           updateNavButtons();
       }

       function showAnalysis(txt) {
           document.getElementById('analysisContent').innerText = txt;
           document.getElementById('analysisBox').style.display = 'block';
       }

       function updateNavButtons() {
           const prev = document.getElementById('prevBtn');
           const next = document.getElementById('nextBtn');
           const isLast = currentIndex === questions.length - 1;

           prev.style.visibility = currentIndex === 0 ? 'hidden' : 'visible';

           if (isReviewMode) {
               next.innerText = 'è¿”å›ç»“æœ';
               next.onclick = showResult;
           } else {
               next.innerText = isLast ? 'æäº¤' : 'ä¸‹ä¸€é¢˜';
               next.onclick = isLast ? showResult : nextQ;
           }
       }

       function prevQ() {
           if (currentIndex > 0) {
               currentIndex--;
               renderQuestion();
           }
       }

       function nextQ() {
           if (currentIndex < questions.length - 1) {
               currentIndex++;
               renderQuestion();
           }
       }

       function confirmExit() {
           if (isReviewMode) {
               showResult();
           } else if (confirm('ç¡®å®šé€€å‡ºï¼Ÿå½“å‰è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
               resetImport();
           }
       }

       function showResult() {
           switchView('resultView');
           isReviewMode = false;

           let correct = 0;
           userAnswers.forEach(u => { if (u && u.isCorrect) correct++; });
           const pct = questions.length ? Math.round((correct / questions.length) * 100) : 0;

           const circle = document.getElementById('scoreCircle');
           const circumference = 2 * Math.PI * 60;
           const offset = circumference - (pct / 100) * circumference;
           circle.style.strokeDasharray = circumference;
           circle.style.strokeDashoffset = circumference;
           setTimeout(() => { circle.style.strokeDashoffset = offset; }, 50);

           document.getElementById('scoreVal').innerText = pct;

           const grid = document.getElementById('resultGrid');
           grid.innerHTML = '';
           questions.forEach((q, i) => {
               const dot = document.createElement('div');
               dot.className = 'grid-dot';
               dot.innerText = i + 1;
               const ans = userAnswers[i];
               if (ans) {
                   dot.classList.add(ans.isCorrect ? 'correct' : 'wrong');
               }
               dot.onclick = () => {
                   currentIndex = i;
                   isReviewMode = true;
                   renderQuestion();
                   switchView('quizView');
               };
               grid.appendChild(dot);
           });
       }

       // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
       window.addEventListener('DOMContentLoaded', init);
   </script>
</body>
</html>
